{% extends "dashboard/base.html" %}
{% load static %}
{% block title %}–ê–≤—Ç–æ {% if car %}{{ car.VIN }}{% else %}{{ vin }}{% endif %}{% endblock %}

{% block content %}
<div class="container py-5" style="max-width: 1000px;">
  {% if not_found %}
    <div class="alert alert-danger">–ú–∞—à–∏–Ω–∞ —Å VIN <span class="font-monospace">{{ vin }}</span> –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.</div>
    <a href="{% url 'users_dashboard' %}" class="btn btn-secondary mt-2">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
  {% else %}
    <a href="{% url 'users_dashboard' %}" class="btn btn-outline-secondary mb-3">‚Üê –ö –æ–±—ä—è–≤–ª–µ–Ω–∏—è–º üöó</a>

    <div class="card border-0 shadow-lg mb-4">
      <div class="card-body">
        <h3 class="mb-1 text-body">{{ car.make_name }} {{ car.model_name }}{% if car.year %} ¬∑ {{ car.year }}{% endif %}</h3>
        <div class="mb-3 small text-secondary">VIN: <span class="font-monospace">{{ car.VIN }}</span></div>

        <div class="d-flex align-items-center gap-2 mb-3">
          <span class="h4 mb-0 fw-bold text-body">{{ car.price_fmt }} ‚ÇΩ</span>
          <span id="statusBadge" class="badge
            {% if car.status == 'available' %}bg-success
            {% elif car.status == 'reserved' %}bg-warning text-dark
            {% elif car.status == 'sold' %}bg-danger
            {% else %}bg-secondary{% endif %}">
            {{ car.status_ru }}
          </span>
        </div>

        <div class="d-flex flex-wrap align-items-center gap-2 mb-3">
          <button id="orderBtn"
                  class="btn btn-primary btn-sm"
                  data-vin="{{ car.VIN }}"
                  {% if car.status != 'available' or me and me.id == car.seller or request.session.is_admin_or_analitic %}disabled{% endif %}>
            {% if request.session.is_admin_or_analitic %}
              –†–µ–∑–µ—Ä–≤ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
            {% elif me and me.id == car.seller %}
              –ù–µ–ª—å–∑—è –∫—É–ø–∏—Ç—å —Å–≤–æ—ë –∞–≤—Ç–æ
            {% else %}
              –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑
            {% endif %}
          </button>

          <button id="payBtn" class="btn btn-success btn-sm" disabled>–û–ø–ª–∞—Ç–∏—Ç—å</button>

          <button id="favBtn"
                  class="btn btn-outline-info btn-sm"
                  data-vin="{{ car.VIN }}"
                  {% if not me or request.session.is_admin_or_analitic %}disabled{% endif %}>
            –í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ ‚òÖ
          </button>

          <div id="orderAlert" class="alert d-none py-1 px-2 mb-0 ms-0 ms-lg-2" role="alert"></div>
        </div>

        <dl class="row small">
          <dt class="col-5 text-secondary">–ü—Ä–æ–¥–∞–≤–µ—Ü (–§.–ò)</dt>
          <dd class="col-7 text-body">{{ car.seller_full_name }}</dd>

          <dt class="col-5 text-secondary">–°–æ–∑–¥–∞–Ω–æ</dt>
          <dd class="col-7 text-body">{{ car.created_at_fmt }}</dd>
        </dl>

        <div class="mt-3">
          <div class="text-secondary mb-1">–û–ø–∏—Å–∞–Ω–∏–µ</div>
          <div class="p-3 rounded bg-body-tertiary border">{{ car.description|default:"‚Äî" }}</div>
        </div>

        <hr class="my-4">

        <div id="sellerRatingBlock" class="mb-3">
          <div class="d-flex align-items-center gap-2 mb-1">
            <strong class="text-body">–†–µ–π—Ç–∏–Ω–≥ –ø—Ä–æ–¥–∞–≤—Ü–∞:</strong>
            {% if seller_rating_avg %}
              <span class="badge bg-info text-dark">{{ seller_rating_avg }} / 5</span>
              <span class="text-secondary small">({{ seller_rating_count }} –æ—Ç–∑—ã–≤–æ–≤)</span>
            {% else %}
              <span class="text-secondary">–ø–æ–∫–∞ –Ω–µ—Ç –æ—Ü–µ–Ω–æ–∫</span>
            {% endif %}
          </div>
          <div aria-hidden="true" class="mb-2">
            {% with avg=seller_rating_avg|default:0 %}
              {% for i in "12345" %}
                {% if forloop.counter <= avg|floatformat:0 %}
                  <span>‚òÖ</span>
                {% else %}
                  <span>‚òÜ</span>
                {% endif %}
              {% endfor %}
            {% endwith %}
          </div>
        </div>

        <div id="myReviewTop" class="mb-3"></div>

        <div id="reviewsList" class="mb-3">
          {% if seller_reviews %}
            <ul class="list-group">
              {% for rv in seller_reviews %}
                <li class="list-group-item d-flex justify-content-between align-items-start bg-body-tertiary border text-body"
                    data-review-id="{{ rv.id }}" data-author-id="{{ rv.author }}">
                  <div class="rv-left">
                    <div class="fw-semibold rv-rating">–û—Ü–µ–Ω–∫–∞: {{ rv.rating }} / 5</div>
                    {% if rv.comment %}
                      <div class="small text-secondary mt-1 rv-comment">{{ rv.comment }}</div>
                    {% endif %}
                  </div>
                  <div class="small text-secondary ms-3 rv-right">
                    {{ rv.created_at|default:"" }}
                  </div>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <div class="text-secondary">–ü–æ–∫–∞ –Ω–µ—Ç –æ—Ç–∑—ã–≤–æ–≤.</div>
          {% endif %}
        </div>

        {% if can_review %}
          <div id="reviewFormWrap" class="p-3 rounded bg-body-tertiary border">
            <div class="mb-2 fw-semibold text-body">–û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤ –ø—Ä–æ–¥–∞–≤—Ü—É</div>
            <div class="row g-2">
              <div class="col-12 col-md-3">
                <label class="form-label small mb-1 text-secondary">–û—Ü–µ–Ω–∫–∞</label>
                <select id="reviewRating" class="form-select">
                  <option value="1">1 ‚òÖ</option>
                  <option value="2">2 ‚òÖ‚òÖ</option>
                  <option value="3" selected>3 ‚òÖ‚òÖ‚òÖ</option>
                  <option value="4">4 ‚òÖ‚òÖ‚òÖ‚òÖ</option>
                  <option value="5">5 ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</option>
                </select>
              </div>
              <div class="col-12 col-md-9">
                <label class="form-label small mb-1 text-secondary">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                <textarea id="reviewComment" class="form-control" rows="2" placeholder="–ö–æ—Ä–æ—Ç–∫–æ –æ–ø–∏—à–∏—Ç–µ –æ–ø—ã—Ç —Å–¥–µ–ª–∫–∏"></textarea>
              </div>
            </div>
            <div class="d-flex align-items-center gap-2 mt-3">
              <button id="sendReviewBtn" class="btn btn-primary btn-sm">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</button>
              <div id="reviewAlert" class="alert d-none py-1 px-2 mb-0" role="alert"></div>
            </div>
          </div>
        {% elif my_already_reviewed %}
          <div class="alert alert-secondary mt-2">–í—ã —É–∂–µ –æ—Å—Ç–∞–≤–∏–ª–∏ –æ—Ç–∑—ã–≤ —ç—Ç–æ–º—É –ø—Ä–æ–¥–∞–≤—Ü—É.</div>
        {% elif me and me.id == car.seller %}
          <div class="alert alert-secondary mt-2">–ù–µ–ª—å–∑—è –æ—Å—Ç–∞–≤–ª—è—Ç—å –æ—Ç–∑—ã–≤ –Ω–∞ —Å–∞–º–æ–≥–æ —Å–µ–±—è.</div>
        {% endif %}
      </div>
    </div>

    <div class="card border-0 shadow-lg">
      <div class="card-header border-bottom">
        <strong class="text-body">–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏</strong>
        <small class="text-secondary ms-2">–©—ë–ª–∫–Ω–∏—Ç–µ –ø–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å</small>
      </div>
      <div class="card-body">
        {% if car.images %}
          <div class="row g-3">
            {% for url in car.images %}
              <div class="col-6 col-md-4 col-lg-3">
                <a href="#" class="lb-thumb d-block" data-index="{{ forloop.counter0 }}">
                  <img src="{{ url }}"
                       class="w-100 rounded border"
                       style="aspect-ratio:16/10;object-fit:cover;"
                       alt="–§–æ—Ç–æ {{ forloop.counter }}">
                </a>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="text-secondary">–ù–µ—Ç —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π.</div>
        {% endif %}
      </div>
    </div>

    <div id="lightbox" aria-hidden="true">
      <button class="lb-btn lb-close" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
      <button class="lb-btn lb-prev" aria-label="–ü—Ä–µ–¥—ã–¥—É—â–µ–µ">‚Äπ</button>
      <button class="lb-btn lb-next" aria-label="–°–ª–µ–¥—É—é—â–µ–µ">‚Ä∫</button>
      <div class="lb-stage">
        <img id="lb-img" alt="–§–æ—Ç–æ">
      </div>
      <div class="lb-counter" id="lb-counter"></div>
    </div>

  {% endif %}
</div>

<div class="modal fade" id="payModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">–û–ø–ª–∞—Ç–∞</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
      </div>
      <div class="modal-body">
        <div id="payStepInit">
          <p class="mb-2">–°—É–º–º–∞ –∫ –æ–ø–ª–∞—Ç–µ: <b><span id="payAmount"></span> ‚ÇΩ</b></p>
          <p class="text-secondary mb-3">–ò–º–∏—Ç–∏—Ä—É–µ–º –ø–ª–∞—Ç—ë–∂ –±–µ–∑ –≤–≤–æ–¥–∞ –∫–∞—Ä—Ç–æ—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.</p>
          <button id="startPay" class="btn btn-success w-100">–ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–ø–ª–∞—Ç–µ</button>
        </div>

        <div id="payStepProcessing" class="d-none text-center">
          <div class="spinner-border" role="status"></div>
          <p class="mt-3 mb-0">–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–∞‚Ä¶</p>
        </div>

        <div id="payStep3DS" class="d-none">
          <p class="mb-2">3-D Secure (—Å–∏–º—É–ª—è—Ü–∏—è)</p>
          <p class="text-secondary">–ù–∞–∂–º–∏—Ç–µ ¬´–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å¬ª, —á—Ç–æ–±—ã –∑–∞–≤–µ—Ä—à–∏—Ç—å.</p>
          <div class="d-flex gap-2">
            <button id="confirm3ds" class="btn btn-primary flex-grow-1">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
            <button id="cancel3ds" class="btn btn-outline-secondary flex-grow-1">–û—Ç–º–µ–Ω–∞</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  /* –õ–∞–π—Ç–±–æ–∫—Å (–æ—Å—Ç–∞—ë—Ç—Å—è —Ç—ë–º–Ω—ã–º –æ–≤–µ—Ä–ª–µ–µ–º –≤ –æ–±–µ–∏—Ö —Ç–µ–º–∞—Ö) */
  #lightbox {
    position: fixed; inset: 0; z-index: 2000;
    display: none;
    background: rgba(0,0,0,.9);
  }
  #lightbox.lb-open { display: block; }
  #lightbox .lb-stage {
    position: absolute; inset: 0; display: flex;
    align-items: center; justify-content: center;
    padding: 4rem 4.5rem 3rem;
  }
  #lightbox img {
    max-width: 100%; max-height: 100%;
    object-fit: contain; box-shadow: 0 10px 30px rgba(0,0,0,.5);
    border-radius: .5rem;
  }
  .lb-btn {
    position: absolute; top: 1rem;
    background: rgba(255,255,255,.08);
    color: var(--bs-body-color);
    border: 1px solid rgba(255,255,255,.15);
    width: 2.5rem; height: 2.5rem; border-radius: .5rem;
    display:flex; align-items:center; justify-content:center;
    cursor: pointer; backdrop-filter: blur(4px);
    transition: background .15s ease, transform .1s ease;
  }
  .lb-btn:hover { background: rgba(255,255,255,.18); transform: translateY(-1px); }
  .lb-close { right: 1rem; }
  .lb-prev { left: 1rem; top: 50%; transform: translateY(-50%); font-size: 1.5rem; }
  .lb-next { right: 1rem; top: 50%; transform: translateY(-50%); font-size: 1.5rem; }

  .lb-counter {
    position: absolute; bottom: .8rem; left: 50%;
    transform: translateX(-50%);
    color: var(--bs-secondary-color);
    font-size:.9rem;
    background: rgba(255,255,255,.08);
    padding:.25rem .5rem; border-radius:.35rem;
    border:1px solid rgba(255,255,255,.15);
  }

  /* –§–æ–ª–±—ç–∫ –¥–ª—è –º–æ–¥–∞–ª–∫–∏, –µ—Å–ª–∏ bootstrap.Modal –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω */
  .modal.manual-show { display: block !important; }
  .modal-backdrop.manual { position: fixed; inset: 0; background: rgba(0,0,0,.5); z-index: 1050; }
</style>

<script>
{% autoescape off %}
(function () {
  const API   = "http://127.0.0.1:8000/api/v1";
  const TOKEN = "{{ request.session.api_token|default:'' }}";
  const HJSON = { "Authorization": "Token " + TOKEN, "Content-Type": "application/json" };
  const IS_ADMIN_OR_ANALITIC = {{ request.session.is_admin_or_analitic|yesno:"true,false" }};
  const ME_ID = {{ me.id|default:'null' }};

  const vin          = "{{ car.VIN }}";
  const orderBtn     = document.getElementById('orderBtn');
  const payBtn       = document.getElementById('payBtn');
  const alertBox     = document.getElementById('orderAlert');
  const statusBadge  = document.getElementById('statusBadge');

  const thumbs     = document.querySelectorAll('.lb-thumb');
  const lb         = document.getElementById('lightbox');
  const lbImg      = document.getElementById('lb-img');
  const lbCounter  = document.getElementById('lb-counter');
  const btnClose   = lb.querySelector('.lb-close');
  const btnPrev    = lb.querySelector('.lb-prev');
  const btnNext    = lb.querySelector('.lb-next');

  const images = Array.from(document.querySelectorAll('.lb-thumb img')).map(img => img.getAttribute('src'));
  let idx = 0;

  function updateLightbox() {
    lbImg.src = images[idx];
    lbCounter.textContent = (idx+1) + " / " + images.length;
  }
  function openLightbox(i=0) {
    if (!images.length) return;
    idx = Math.max(0, Math.min(i, images.length-1));
    updateLightbox();
    lb.classList.add('lb-open');
    lb.setAttribute('aria-hidden','false');
    document.body.style.overflow = 'hidden';
  }
  function closeLightbox() {
    lb.classList.remove('lb-open');
    lb.setAttribute('aria-hidden','true');
    document.body.style.overflow = '';
  }
  function nextImg() { idx = (idx + 1) % images.length; updateLightbox(); }
  function prevImg() { idx = (idx - 1 + images.length) % images.length; updateLightbox(); }

  thumbs.forEach(a => {
    a.addEventListener('click', (e) => {
      e.preventDefault();
      const i = Number(a.dataset.index || 0);
      openLightbox(i);
    });
  });
  btnClose.addEventListener('click', closeLightbox);
  btnNext.addEventListener('click', nextImg);
  btnPrev.addEventListener('click', prevImg);

  document.addEventListener('keydown', (e) => {
    if (!lb.classList.contains('lb-open')) return;
    if (e.key === 'Escape') closeLightbox();
    if (e.key === 'ArrowRight') nextImg();
    if (e.key === 'ArrowLeft')  prevImg();
  });

  lb.addEventListener('click', (e) => {
    if (e.target === lb || e.target === lb.querySelector('.lb-stage')) closeLightbox();
  });
  let touchX = null;
  lb.addEventListener('touchstart', (e) => { touchX = e.changedTouches[0].clientX; }, {passive:true});
  lb.addEventListener('touchend', (e) => {
    if (touchX === null) return;
    const dx = e.changedTouches[0].clientX - touchX;
    if (Math.abs(dx) > 40) (dx < 0 ? nextImg() : prevImg());
    touchX = null;
  }, {passive:true});

  const sendBtn      = document.getElementById('sendReviewBtn');
  const ratingEl     = document.getElementById('reviewRating');
  const commentEl    = document.getElementById('reviewComment');
  const reviewAlert  = document.getElementById('reviewAlert');
  const sellerId     = {{ car.seller|default:'null' }};

  function showAlert(kind, text) {
    alertBox.className = `alert alert-${kind} py-1 px-2 mb-0`;
    alertBox.textContent = text;
    alertBox.classList.remove('d-none');
  }
  function hideAlert(){
    alertBox.className='alert d-none py-1 px-2 mb-0';
    alertBox.textContent='';
  }
  function showReviewAlert(kind, text) {
    reviewAlert.className = `alert alert-${kind} py-1 px-2 mb-0`;
    reviewAlert.textContent = text;
    reviewAlert.classList.remove('d-none');
    setTimeout(() => reviewAlert.classList.add('d-none'), 3000);
  }

  function setStatusReservedUI() {
    statusBadge.className = 'badge bg-warning text-dark';
    statusBadge.textContent = '–∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–æ';
    orderBtn.disabled = true;
    orderBtn.textContent = '–ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω';
  }
  function setStatusSoldUI() {
    statusBadge.className = 'badge bg-danger';
    statusBadge.textContent = '–ø—Ä–æ–¥–∞–Ω–æ';
    orderBtn.disabled = true;
    payBtn.disabled = true;
  }

  function enablePayButton(order) {
    currentOrder = order;
    if ((order?.status || '').toLowerCase() === 'pending') {
      payBtn.disabled = false;
      payBtn.removeAttribute('disabled');
      payBtn.classList.remove('disabled');
    }
  }

  async function createOrder() {
    const r = await fetch(`${API}/cars/${vin}/reserve/`, {
      method: 'POST',
      headers: HJSON,
      body: JSON.stringify({})
    });
    const data = await r.json().catch(()=>null);
    if (!r.ok) throw new Error((data && (data.detail || data.error)) || `HTTP ${r.status}`);
    return data;
  }

  let currentOrder = null;

  async function fetchMyPendingOrder() {
    if (!TOKEN) return null;
    const r = await fetch(`${API}/orders/`, { headers: HJSON });
    const list = await r.json().catch(()=>[]);
    if (!Array.isArray(list)) return null;
    return list.find(o => String(o.car) === String(vin) && o.status === 'pending') || null;
  }

  async function pingCancelExpired() {
    try {
      await fetch(`${API}/orders/cancel_expired/`, { method: 'POST', headers: HJSON, body: JSON.stringify({}) });
    } catch {}
  }

  async function refreshMyPendingOrder() {
    await pingCancelExpired();
    return await fetchMyPendingOrder();
  }

  orderBtn?.addEventListener('click', async () => {
    hideAlert();
    if (!TOKEN) { showAlert('warning', '–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑.'); return; }
    if (orderBtn.disabled) return;
    if (IS_ADMIN_OR_ANALITIC) { showAlert('warning', '–†–µ–∑–µ—Ä–≤ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞.'); return; }

    orderBtn.disabled = true;
    const prevText = orderBtn.textContent;
    orderBtn.textContent = '–û—Ñ–æ—Ä–º–ª—è–µ–º‚Ä¶';

    try {
      const order = await createOrder();
      setStatusReservedUI();
      enablePayButton(order);
      showAlert('success', '–ó–∞–∫–∞–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω. –ú–∞—à–∏–Ω–∞ –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∞. –ú–æ–∂–Ω–æ –æ–ø–ª–∞—á–∏–≤–∞—Ç—å.');
    } catch (e) {
      const msg = String(e && e.message ? e.message : e);
      if (msg.toLowerCase().includes('—Å–æ–±—Å—Ç–≤–µ–Ω–Ω') || msg.toLowerCase().includes('–Ω–µ–ª—å–∑—è —Å–¥–µ–ª–∞—Ç—å –∑–∞–∫–∞–∑')) {
        showAlert('info', '–í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –∫—É–ø–∏—Ç—å —Å–≤–æ–π —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –∞–≤—Ç–æ–º–æ–±–∏–ª—å.');
      } else {
        showAlert('danger', msg);
      }
      orderBtn.disabled = false;
      orderBtn.textContent = prevText;
    }
  });

  function resetPayModal() {
    const stepInit     = document.getElementById('payStepInit');
    const stepProc     = document.getElementById('payStepProcessing');
    const step3ds      = document.getElementById('payStep3DS');
    stepInit.classList.remove('d-none');
    stepProc.classList.add('d-none');
    step3ds.classList.add('d-none');
  }

  const payModalEl   = document.getElementById('payModal');
  const payAmountEl  = document.getElementById('payAmount');
  const stepInit     = document.getElementById('payStepInit');
  const stepProc     = document.getElementById('payStepProcessing');
  const step3ds      = document.getElementById('payStep3DS');
  const startPayBtn  = document.getElementById('startPay');
  const confirm3dsBtn= document.getElementById('confirm3ds');
  const cancel3dsBtn = document.getElementById('cancel3ds');

  let payModal = null;
  const hasBsModal = !!(window.bootstrap && typeof bootstrap.Modal === 'function');
  if (hasBsModal && payModalEl) {
    payModal = new bootstrap.Modal(payModalEl);
  }
  let manualBackdrop = null;
  function openModalFallback() {
    if (!payModalEl) return;
    payModalEl.classList.add('manual-show', 'show');
    payModalEl.removeAttribute('aria-hidden');
    payModalEl.style.display = 'block';
    manualBackdrop = document.createElement('div');
    manualBackdrop.className = 'modal-backdrop manual';
    document.body.appendChild(manualBackdrop);
    document.body.classList.add('modal-open');
  }
  function closeModalFallback() {
    if (!payModalEl) return;
    payModalEl.classList.remove('manual-show', 'show');
    payModalEl.setAttribute('aria-hidden', 'true');
    payModalEl.style.display = 'none';
    if (manualBackdrop) { manualBackdrop.remove(); manualBackdrop = null; }
    document.body.classList.remove('modal-open');
  }
  function openPayModal() { hasBsModal ? payModal.show() : openModalFallback(); }
  function closePayModal() { hasBsModal ? payModal.hide() : closeModalFallback(); }

  payBtn?.addEventListener('click', async () => {
    hideAlert();
    if (!TOKEN) { showAlert('warning', '–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –æ–ø–ª–∞—Ç–∏—Ç—å.'); return; }

    if (!currentOrder) {
      try { currentOrder = await refreshMyPendingOrder(); } catch(e) { console.error(e); }
    }
    if (!currentOrder) {
      showAlert('warning','–ë—Ä–æ–Ω—å –∏—Å—Ç–µ–∫–ª–∞ –∏ –∑–∞–∫–∞–∑ –æ—Ç–º–µ–Ω—ë–Ω. –û—Ñ–æ—Ä–º–∏—Ç–µ –∑–∞–∫–∞–∑ –∑–∞–Ω–æ–≤–æ.');
      statusBadge.className = 'badge bg-success';
      statusBadge.textContent = '–ø—Ä–æ–¥–∞—ë—Ç—Å—è';
      orderBtn.disabled = false;
      orderBtn.textContent = '–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑';
      payBtn.disabled = true;
      return;
    }
    if (currentOrder.status !== 'pending') {
      showAlert('warning','–≠—Ç–æ—Ç –∑–∞–∫–∞–∑ —É–∂–µ –Ω–µ –æ–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã.');
      return;
    }

    const amount = (currentOrder.total_amount ?? '').toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
    payAmountEl.textContent = amount;
    resetPayModal();
    (payModal ? payModal.show() : openModalFallback());
  });

  startPayBtn?.addEventListener('click', () => {
    stepInit.classList.add('d-none');
    stepProc.classList.remove('d-none');
    setTimeout(() => {
      stepProc.classList.add('d-none');
      step3ds.classList.remove('d-none');
    }, 1200);
  });

  cancel3dsBtn?.addEventListener('click', () => {
    (payModal ? payModal.hide() : closeModalFallback());
    showAlert('secondary', '–û–ø–ª–∞—Ç–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞.');
  });

  let isPaying = false;
  confirm3dsBtn?.addEventListener('click', async () => {
    if (isPaying) return;
    isPaying = true;
    try {
      step3ds.classList.add('d-none');
      stepProc.classList.remove('d-none');

      const r = await fetch(`${API}/orders/${currentOrder.id}/confirm/`, {
        method: 'POST',
        headers: HJSON,
        body: JSON.stringify({})
      });
      const data = await r.json().catch(() => null);

      if (!r.ok) {
        const msg = (data && (data.detail || data.error)) || r.statusText || `HTTP ${r.status}`;
        showAlert('danger', String(msg));
        return;
      }

      (payModal ? payModal.hide() : closeModalFallback());
      showAlert('success', '–û–ø–ª–∞—Ç–∞ –ø—Ä–æ—à–ª–∞. –°–ø–∞—Å–∏–±–æ!');
      setStatusSoldUI();

      const receiptUrl = (data && data.receipt_url) ? data.receipt_url : (data && data.id ? `/receipt/${data.id}/` : null);
      if (receiptUrl) {
        window.location.href = receiptUrl;
      }
    } catch (e) {
      (payModal ? payModal.hide() : closeModalFallback());
      showAlert('danger', String(e));
    } finally {
      stepProc.classList.add('d-none');
      isPaying = false;
    }
  });

  (async () => {
    try {
      if (!TOKEN) return;
      const pending = await fetchMyPendingOrder();
      if (pending) {
        setStatusReservedUI();
        enablePayButton(pending);
      }
    } catch (e) { console.error(e); }
  })();

  const favBtn = document.getElementById('favBtn');
  let currentFavId = null;

  function setFavUI(isFav) {
    if (!favBtn) return;
    if (isFav) {
      favBtn.classList.remove('btn-outline-info');
      favBtn.classList.add('btn-info');
      favBtn.textContent = '–í –∏–∑–±—Ä–∞–Ω–Ω–æ–º ‚úì';
    } else {
      favBtn.classList.remove('btn-info');
      favBtn.classList.add('btn-outline-info');
      favBtn.textContent = '–í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ ‚òÖ';
    }
  }

  async function fetchIsFav() {
    if (!favBtn || !TOKEN) return;
    try {
      const r = await fetch(`${API}/favorites/?car=${encodeURIComponent(vin)}`, {
        headers: { "Authorization": "Token " + TOKEN }
      });
      if (!r.ok) return;
      const data = await r.json();
      const list = Array.isArray(data) ? data :
                   (Array.isArray(data.results) ? data.results : []);
      if (list.length) {
        currentFavId = list[0].id;
        setFavUI(true);
      } else {
        currentFavId = null;
        setFavUI(false);
      }
    } catch {}
  }

  async function addFav() {
    if (!TOKEN) { showAlert('warning','–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–∑–±—Ä–∞–Ω–Ω–æ–µ.'); return; }
    try {
      favBtn.disabled = true;
      const r = await fetch(`${API}/favorites/`, {
        method: 'POST',
        headers: { "Authorization": "Token " + TOKEN, "Content-Type": "application/json" },
        body: JSON.stringify({ car: vin })
      });
      const data = await r.json().catch(()=>null);
      if (!r.ok) throw new Error(data?.detail || r.statusText);
      currentFavId = data.id;
      setFavUI(true);
    } catch (e) {
      showAlert('danger', String(e));
    } finally {
      favBtn.disabled = false;
    }
  }

  async function delFav() {
    if (!TOKEN || !currentFavId) return;
    try {
      favBtn.disabled = true;
      const r = await fetch(`${API}/favorites/${currentFavId}/`, {
        method: 'DELETE',
        headers: { "Authorization": "Token " + TOKEN }
      });
      if (!r.ok && r.status !== 204) {
        const t = await r.text();
        throw new Error(t || r.statusText);
      }
      currentFavId = null;
      setFavUI(false);
    } catch (e) {
      showAlert('danger', String(e));
    } finally {
      favBtn.disabled = false;
    }
  }

  favBtn?.addEventListener('click', () => {
    if (!TOKEN) { showAlert('warning','–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–∑–±—Ä–∞–Ω–Ω–æ–µ.'); return; }
    if ({{ request.session.is_admin_or_analitic|yesno:"true,false" }}) {
      showAlert('warning','–ò–∑–±—Ä–∞–Ω–Ω–æ–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞/–∞–Ω–∞–ª–∏—Ç–∏–∫–∞.');
      return;
    }
    if (currentFavId) delFav(); else addFav();
  });

  fetchIsFav();

  sendBtn?.addEventListener('click', async () => {
    if (!TOKEN) {
      showReviewAlert('warning', '–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤.');
      return;
    }
    if (!sellerId) {
      showReviewAlert('danger', '–ù–µ –Ω–∞–π–¥–µ–Ω –ø—Ä–æ–¥–∞–≤–µ—Ü –¥–ª—è –æ—Ç–∑—ã–≤–∞.');
      return;
    }

    const rating = parseInt(ratingEl.value, 10);
    const comment = (commentEl.value || '').trim();

    if (!(rating >= 1 && rating <= 5)) {
      showReviewAlert('warning', '–†–µ–π—Ç–∏–Ω–≥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 1 –¥–æ 5.');
      return;
    }

    try {
      sendBtn.disabled = true;

      const r = await fetch(`${API}/reviews/`, {
        method: 'POST',
        headers: { "Authorization": "Token " + TOKEN, "Content-Type": "application/json" },
        body: JSON.stringify({ target: sellerId, rating, comment })
      });
      const data = await r.json().catch(() => null);

      if (!r.ok) {
        const msg = (data && (data.detail || data.error)) || `HTTP ${r.status}`;
        const low = String(msg).toLowerCase();
        if (low.includes('—Å–∞–º–æ–º—É —Å–µ–±–µ')) {
          showReviewAlert('info', '–ù–µ–ª—å–∑—è –æ—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤ —Å–∞–º–æ–º—É —Å–µ–±–µ.');
        } else if (low.includes('unique') || low.includes('—É–Ω–∏–∫')) {
          showReviewAlert('secondary', '–¢—ã —É–∂–µ –æ—Å—Ç–∞–≤–ª—è–ª(–∞) –æ—Ç–∑—ã–≤ —ç—Ç–æ–º—É –ø—Ä–æ–¥–∞–≤—Ü—É.');
        } else {
          showReviewAlert('danger', String(msg));
        }
        sendBtn.disabled = false;
        return;
      }

      const reviewsList = document.getElementById('reviewsList');
      let ul = reviewsList.querySelector('ul.list-group');
      if (!ul) {
        reviewsList.innerHTML = '<ul class="list-group"></ul>';
        ul = reviewsList.querySelector('ul.list-group');
      }

      const li = document.createElement('li');
      li.className = 'list-group-item d-flex justify-content-between align-items-start bg-body-tertiary border text-body';
      li.dataset.reviewId = data?.id ?? '';
      li.dataset.authorId = String(ME_ID || '');
      li.innerHTML = `
        <div class="rv-left">
          <div class="fw-semibold rv-rating">–û—Ü–µ–Ω–∫–∞: ${rating} / 5</div>
          ${comment ? `<div class="small text-secondary mt-1 rv-comment"></div>` : ``}
        </div>
        <div class="small text-secondary ms-3 rv-right">${new Date().toLocaleDateString()}</div>
      `;
      if (comment) li.querySelector('.rv-comment').textContent = comment;
      ul.prepend(li);

      addOwnerControls(li);

      showReviewAlert('success', '–û—Ç–∑—ã–≤ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω.');
      sendBtn.disabled = true;
      ratingEl.disabled = true;
      commentEl.disabled = true;

    } catch (e) {
      showReviewAlert('danger', String(e));
      sendBtn.disabled = false;
    }
  });

  function addOwnerControls(li) {
    const rid = li.dataset.reviewId;
    const aid = parseInt(li.dataset.authorId || '0', 10);

    if (!ME_ID || !rid || !aid || aid !== ME_ID) return;

    if (li.querySelector('.rv-actions')) return;

    const right = li.querySelector('.rv-right') || document.createElement('div');
    right.classList.add('rv-right');

    const wrap = document.createElement('div');
    wrap.className = 'rv-actions mt-2 d-flex gap-2 justify-content-end';

    const btnEdit = document.createElement('button');
    btnEdit.className = 'btn btn-outline-primary btn-sm';
    btnEdit.textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å';
    btnEdit.addEventListener('click', () => enterEditMode(li));

    const btnDel = document.createElement('button');
    btnDel.className = 'btn btn-outline-danger btn-sm';
    btnDel.textContent = '–£–¥–∞–ª–∏—Ç—å';
    btnDel.addEventListener('click', () => deleteReview(li));

    wrap.appendChild(btnEdit);
    wrap.appendChild(btnDel);

    right.appendChild(wrap);
    li.appendChild(right);
  }

  function enterEditMode(li) {
    const left = li.querySelector('.rv-left');
    const ratingText = left.querySelector('.rv-rating')?.textContent || '';
    const currentRating = parseInt((ratingText.match(/(\d+)/) || [])[1] || '5', 10);
    const currentComment = left.querySelector('.rv-comment')?.textContent || '';

    li._origLeftHTML = left.innerHTML;

    const editor = document.createElement('div');
    editor.innerHTML = `
      <div class="row g-2">
        <div class="col-12 col-md-3">
          <select class="form-select rv-edit-rating">
            <option value="1">1 ‚òÖ</option>
            <option value="2">2 ‚òÖ‚òÖ</option>
            <option value="3">3 ‚òÖ‚òÖ‚òÖ</option>
            <option value="4">4 ‚òÖ‚òÖ‚òÖ‚òÖ</option>
            <option value="5">5 ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</option>
          </select>
        </div>
        <div class="col-12 col-md-9">
          <textarea class="form-control rv-edit-comment" rows="2" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)"></textarea>
        </div>
      </div>
      <div class="d-flex gap-2 mt-2">
        <button class="btn btn-primary btn-sm rv-save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button class="btn btn-outline-secondary btn-sm rv-cancel">–û—Ç–º–µ–Ω–∞</button>
      </div>
    `;
    left.innerHTML = '';
    left.appendChild(editor);

    const sel = left.querySelector('.rv-edit-rating');
    const ta  = left.querySelector('.rv-edit-comment');
    sel.value = String(currentRating);
    ta.value  = currentComment;

    left.querySelector('.rv-cancel').addEventListener('click', () => {
      left.innerHTML = li._origLeftHTML;
      delete li._origLeftHTML;
    });

    left.querySelector('.rv-save').addEventListener('click', async () => {
      const rating = parseInt(sel.value, 10);
      const comment = ta.value.trim();
      if (!(rating >= 1 && rating <= 5)) {
        showReviewAlert('warning', '–†–µ–π—Ç–∏–Ω–≥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 1 –¥–æ 5.');
        return;
      }
      try {
        const rid = li.dataset.reviewId;
        const r = await fetch(`${API}/reviews/${rid}/`, {
          method: 'PATCH',
          headers: HJSON,
          body: JSON.stringify({ rating, comment })
        });
        const data = await r.json().catch(()=>null);
        if (!r.ok) {
          const msg = (data && (data.detail || data.error)) || `HTTP ${r.status}`;
          showReviewAlert('danger', String(msg));
          return;
        }
        left.innerHTML = `
          <div class="fw-semibold rv-rating">–û—Ü–µ–Ω–∫–∞: ${rating} / 5</div>
          ${comment ? `<div class="small text-secondary mt-1 rv-comment"></div>` : ''}
        `;
        if (comment) left.querySelector('.rv-comment').textContent = comment;
        delete li._origLeftHTML;
        showReviewAlert('success', '–û—Ç–∑—ã–≤ –æ–±–Ω–æ–≤–ª—ë–Ω.');
      } catch (e) {
        showReviewAlert('danger', String(e));
      }
    });
  }

  async function deleteReview(li) {
    if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –æ—Ç–∑—ã–≤?')) return;
    try {
      const rid = li.dataset.reviewId;
      const r = await fetch(`${API}/reviews/${rid}/`, {
        method: 'DELETE',
        headers: { "Authorization": "Token " + TOKEN }
      });
      if (!r.ok && r.status !== 204) {
        const msg = await r.text();
        throw new Error(msg || r.statusText);
      }
      li.remove();
      showReviewAlert('success', '–û—Ç–∑—ã–≤ —É–¥–∞–ª—ë–Ω.');

      if (sendBtn) {
        sendBtn.disabled = false;
        ratingEl.disabled = false;
        commentEl.disabled = false;
      }
    } catch (e) {
      showReviewAlert('danger', String(e));
    }
  }

  document.querySelectorAll('#reviewsList li[data-review-id]').forEach(addOwnerControls);

})();
{% endautoescape %}
</script>
{% endblock %}