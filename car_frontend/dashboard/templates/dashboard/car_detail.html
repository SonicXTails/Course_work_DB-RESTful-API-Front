{% extends "dashboard/base.html" %}
{% load static %}
{% block title %}–ê–≤—Ç–æ {{ vin|default:car.VIN }}{% endblock %}

{% block content %}
<div class="container py-5" style="max-width: 1000px;">
  {% if not_found %}
    <div class="alert alert-danger">–ú–∞—à–∏–Ω–∞ —Å VIN <span class="font-monospace">{{ vin }}</span> –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.</div>
    <a href="{% url 'users_dashboard' %}" class="btn btn-secondary mt-2">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
  {% else %}
    <a href="{% url 'users_dashboard' %}" class="btn btn-outline-secondary mb-3">‚Üê –ö –æ–±—ä—è–≤–ª–µ–Ω–∏—è–º üöó</a>

    <div class="card border-0 shadow-lg" style="background:#1f2a36;color:#e9ecef;">
      <div class="row g-0">
        <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –∫–∞—Ä—É—Å–µ–ª—å -->
        <div class="col-lg-6 p-3">
          <div id="carCarousel" class="carousel slide">
            <div class="carousel-inner">
              {% for url in car.images %}
                <div class="carousel-item {% if forloop.first %}active{% endif %}">
                  <img src="{{ url }}" class="d-block w-100" style="object-fit:cover;aspect-ratio:16/9;" alt="–§–æ—Ç–æ">
                </div>
              {% endfor %}
            </div>
            {% if car.images|length > 1 %}
              <button class="carousel-control-prev" type="button" data-bs-target="#carCarousel" data-bs-slide="prev">
                <span class="carousel-control-prev-icon"></span>
                <span class="visually-hidden">Prev</span>
              </button>
              <button class="carousel-control-next" type="button" data-bs-target="#carCarousel" data-bs-slide="next">
                <span class="carousel-control-next-icon"></span>
                <span class="visually-hidden">Next</span>
              </button>
            {% endif %}
          </div>
        </div>

        <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –∏–Ω—Ñ–æ + –¥–µ–π—Å—Ç–≤–∏—è -->
        <div class="col-lg-6 p-4">
          <h3 class="mb-1">{{ car.make_name }} {{ car.model_name }}{% if car.year %} ¬∑ {{ car.year }}{% endif %}</h3>
          <div class="mb-3 small text-muted">VIN: <span class="font-monospace">{{ car.VIN }}</span></div>

          <div class="d-flex align-items-center gap-2 mb-3">
            <span class="h4 mb-0 fw-bold">{{ car.price_fmt }} ‚ÇΩ</span>
            <span id="statusBadge" class="badge
              {% if car.status == 'available' %}bg-success
              {% elif car.status == 'reserved' %}bg-warning text-dark
              {% elif car.status == 'sold' %}bg-danger
              {% else %}bg-secondary{% endif %}">
              {{ car.status_ru }}
            </span>
          </div>

          <div class="d-flex flex-wrap align-items-center gap-2 mb-3">
            <button id="orderBtn"
                    class="btn btn-primary btn-sm"
                    data-vin="{{ car.VIN }}"
                    {% if car.status != 'available' %}disabled{% endif %}>
              –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑
            </button>

            <button id="payBtn" class="btn btn-success btn-sm" disabled>
              –û–ø–ª–∞—Ç–∏—Ç—å
            </button>

            <div id="orderAlert" class="alert d-none py-1 px-2 mb-0 ms-0 ms-lg-2" role="alert"></div>
          </div>

          <dl class="row small">
            <dt class="col-5 text-soft">–ü—Ä–æ–¥–∞–≤–µ—Ü (–§.–ò)</dt>
            <dd class="col-7 text-plain">{{ car.seller_full_name }}</dd>

            <dt class="col-5 text-soft">–°–æ–∑–¥–∞–Ω–æ</dt>
            <dd class="col-7 text-plain">{{ car.created_at_fmt }}</dd>
          </dl>

          <div class="mt-3">
            <div class="text-muted mb-1">–û–ø–∏—Å–∞–Ω–∏–µ</div>
            <div class="p-3 rounded" style="background:#18222f;border:1px solid #2b3a4a;">
              {{ car.description|default:"‚Äî" }}
            </div>
          </div>
        </div>
      </div>
    </div>
  {% endif %}
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞ –æ–ø–ª–∞—Ç—ã -->
<div class="modal fade" id="payModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="background:#1f2a36;color:#e9ecef;">
      <div class="modal-header">
        <h5 class="modal-title">–û–ø–ª–∞—Ç–∞</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
      </div>
      <div class="modal-body">
        <div id="payStepInit">
          <p class="mb-2">–°—É–º–º–∞ –∫ –æ–ø–ª–∞—Ç–µ: <b><span id="payAmount"></span> ‚ÇΩ</b></p>
          <p class="text-secondary mb-3">–ò–º–∏—Ç–∏—Ä—É–µ–º –ø–ª–∞—Ç—ë–∂ –±–µ–∑ –≤–≤–æ–¥–∞ –∫–∞—Ä—Ç–æ—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.</p>
          <button id="startPay" class="btn btn-success w-100">–ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–ø–ª–∞—Ç–µ</button>
        </div>

        <div id="payStepProcessing" class="d-none text-center">
          <div class="spinner-border" role="status"></div>
          <p class="mt-3 mb-0">–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–∞‚Ä¶</p>
        </div>

        <div id="payStep3DS" class="d-none">
          <p class="mb-2">3-D Secure (—Å–∏–º—É–ª—è—Ü–∏—è)</p>
          <p class="text-secondary">–ù–∞–∂–º–∏—Ç–µ ¬´–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å¬ª, —á—Ç–æ–±—ã –∑–∞–≤–µ—Ä—à–∏—Ç—å.</p>
          <div class="d-flex gap-2">
            <button id="confirm3ds" class="btn btn-primary flex-grow-1">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
            <button id="cancel3ds" class="btn btn-outline-secondary flex-grow-1">–û—Ç–º–µ–Ω–∞</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .card { background:#1f2a36; color:#e9ecef; }
  .text-muted { color:#c8d3e0!important; }
  .text-soft { color:#aebacf!important; }
  .text-plain { color:#eef3f9!important; }
  /* –§–æ–ª–±—ç–∫-–º–æ–¥–∞–ª–∫–∞ –±–µ–∑ Bootstrap JS */
  .modal.manual-show { display: block !important; }
  .modal-backdrop.manual { position: fixed; inset: 0; background: rgba(0,0,0,.5); z-index: 1050; }
</style>

<script>
(function () {
  const API   = "http://127.0.0.1:8000/api/v1";
  const TOKEN = "{{ request.session.api_token|default:'' }}";
  const HJSON = { "Authorization": "Token " + TOKEN, "Content-Type": "application/json" };

  const vin          = "{{ car.VIN }}";
  const orderBtn     = document.getElementById('orderBtn');
  const payBtn       = document.getElementById('payBtn');
  const alertBox     = document.getElementById('orderAlert');
  const statusBadge  = document.getElementById('statusBadge');

  const payModalEl   = document.getElementById('payModal');
  const payAmountEl  = document.getElementById('payAmount');
  const stepInit     = document.getElementById('payStepInit');
  const stepProc     = document.getElementById('payStepProcessing');
  const step3ds      = document.getElementById('payStep3DS');
  const startPayBtn  = document.getElementById('startPay');
  const confirm3dsBtn= document.getElementById('confirm3ds');
  const cancel3dsBtn = document.getElementById('cancel3ds');

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Bootstrap Modal, –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω
  let payModal = null;
  const hasBootstrap = !!(window.bootstrap && typeof bootstrap.Modal === 'function');
  if (hasBootstrap && payModalEl) {
    payModal = new bootstrap.Modal(payModalEl);
  }

  // –§–æ–ª–±—ç–∫: —Ä—É—á–Ω–æ–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ/–∑–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏
  let manualBackdrop = null;
  function openModalFallback() {
    if (!payModalEl) return;
    payModalEl.classList.add('manual-show', 'show');
    payModalEl.removeAttribute('aria-hidden');
    payModalEl.style.display = 'block';
    manualBackdrop = document.createElement('div');
    manualBackdrop.className = 'modal-backdrop manual';
    document.body.appendChild(manualBackdrop);
    document.body.classList.add('modal-open');
  }
  function closeModalFallback() {
    if (!payModalEl) return;
    payModalEl.classList.remove('manual-show', 'show');
    payModalEl.setAttribute('aria-hidden', 'true');
    payModalEl.style.display = 'none';
    if (manualBackdrop) {
      manualBackdrop.remove();
      manualBackdrop = null;
    }
    document.body.classList.remove('modal-open');
  }
  function openPayModal() { hasBootstrap ? payModal.show() : openModalFallback(); }
  function closePayModal() { hasBootstrap ? payModal.hide() : closeModalFallback(); }

  let currentOrder = null;

  function showAlert(kind, text) {
    alertBox.className = `alert alert-${kind} py-1 px-2 mb-0`;
    alertBox.textContent = text;
    alertBox.classList.remove('d-none');
  }
  function hideAlert(){
    alertBox.className='alert d-none py-1 px-2 mb-0';
    alertBox.textContent='';
  }

  function setStatusReservedUI() {
    statusBadge.className = 'badge bg-warning text-dark';
    statusBadge.textContent = '–∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–æ';
    orderBtn.disabled = true;
    orderBtn.textContent = '–ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω';
  }
  function setStatusSoldUI() {
    statusBadge.className = 'badge bg-danger';
    statusBadge.textContent = '–ø—Ä–æ–¥–∞–Ω–æ';
    orderBtn.disabled = true;
    payBtn.disabled = true;
  }

  function enablePayButton(order) {
    currentOrder = order;
    if ((order?.status || '').toLowerCase() === 'pending') {
      payBtn.disabled = false;
      payBtn.removeAttribute('disabled');
      payBtn.classList.remove('disabled');
    }
  }

  function extractApiError(data, fallback='–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞') {
    if (!data) return fallback;
    if (typeof data === 'string') return data;
    if (data.detail) return Array.isArray(data.detail) ? data.detail[0] : String(data.detail);
    if (data.non_field_errors) return Array.isArray(data.non_field_errors) ? data.non_field_errors[0] : String(data.non_field_errors);
    for (const key of ['car','buyer','amount','status','message','error']) {
      if (data[key]) return Array.isArray(data[key]) ? data[key][0] : String(data[key]);
    }
    for (const v of Object.values(data)) {
      if (typeof v === 'string') return v;
      if (Array.isArray(v) && v.length && typeof v[0] === 'string') return v[0];
    }
    try { return JSON.stringify(data); } catch { return fallback; }
  }

  async function createOrder() {
    const r = await fetch(`${API}/orders/`, {
      method: 'POST',
      headers: HJSON,
      body: JSON.stringify({ car: vin })
    });
    const data = await r.json().catch(()=>null);
    if (!r.ok) {
      const msg = extractApiError(data, r.statusText || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑');
      throw new Error(msg);
    }
    return data;
  }

  async function fetchMyPendingOrder() {
    if (!TOKEN) return null;
    const r = await fetch(`${API}/orders/`, { headers: HJSON });
    const list = await r.json().catch(()=>[]);
    if (!Array.isArray(list)) return null;
    return list.find(o => String(o.car) === String(vin) && o.status === 'pending') || null;
  }

  // --- –Ω–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∞–≤—Ç–æ-–æ—Ç–º–µ–Ω—ã ---
  async function pingCancelExpired() {
    try {
      await fetch(`${API}/orders/cancel_expired/`, {
        method: 'POST',
        headers: HJSON,
        body: JSON.stringify({})
      });
    } catch {}
  }

  async function refreshMyPendingOrder() {
    await pingCancelExpired();
    return await fetchMyPendingOrder();
  }
  // -------------------------------------

  // –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑
  orderBtn?.addEventListener('click', async () => {
    hideAlert();
    if (!TOKEN) { showAlert('warning', '–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑.'); return; }
    if (orderBtn.disabled) return;

    orderBtn.disabled = true;
    const prevText = orderBtn.textContent;
    orderBtn.textContent = '–û—Ñ–æ—Ä–º–ª—è–µ–º‚Ä¶';

    try {
      const order = await createOrder();
      setStatusReservedUI();
      enablePayButton(order);
      showAlert('success', '–ó–∞–∫–∞–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω. –ú–∞—à–∏–Ω–∞ –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∞. –ú–æ–∂–Ω–æ –æ–ø–ª–∞—á–∏–≤–∞—Ç—å.');
    } catch (e) {
      const msg = String(e && e.message ? e.message : e);
      if (msg.toLowerCase().includes('—Å–æ–±—Å—Ç–≤–µ–Ω–Ω') || msg.toLowerCase().includes('–Ω–µ–ª—å–∑—è —Å–¥–µ–ª–∞—Ç—å –∑–∞–∫–∞–∑')) {
        showAlert('info', '–í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –∫—É–ø–∏—Ç—å —Å–≤–æ–π —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –∞–≤—Ç–æ–º–æ–±–∏–ª—å.');
      } else {
        showAlert('danger', msg);
      }
      orderBtn.disabled = false;
      orderBtn.textContent = prevText;
    }
  });

  function resetPayModal() {
    stepInit.classList.remove('d-none');
    stepProc.classList.add('d-none');
    step3ds.classList.add('d-none');
  }

  // –û–ø–ª–∞—Ç–∏—Ç—å
  payBtn?.addEventListener('click', async () => {
    hideAlert();
    if (!TOKEN) { showAlert('warning', '–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –æ–ø–ª–∞—Ç–∏—Ç—å.'); return; }

    if (!currentOrder) {
      try { currentOrder = await refreshMyPendingOrder(); } catch(e) { console.error(e); }
    }
    if (!currentOrder) {
      showAlert('warning','–ë—Ä–æ–Ω—å –∏—Å—Ç–µ–∫–ª–∞ –∏ –∑–∞–∫–∞–∑ –æ—Ç–º–µ–Ω—ë–Ω. –û—Ñ–æ—Ä–º–∏—Ç–µ –∑–∞–∫–∞–∑ –∑–∞–Ω–æ–≤–æ.');
      statusBadge.className = 'badge bg-success';
      statusBadge.textContent = '–ø—Ä–æ–¥–∞—ë—Ç—Å—è';
      orderBtn.disabled = false;
      orderBtn.textContent = '–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑';
      payBtn.disabled = true;
      return;
    }
    if (currentOrder.status !== 'pending') {
      showAlert('warning','–≠—Ç–æ—Ç –∑–∞–∫–∞–∑ —É–∂–µ –Ω–µ –æ–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã.');
      return;
    }

    payAmountEl.textContent = (currentOrder.total_amount ?? '').toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
    resetPayModal();
    openPayModal();
  });

  // 3DS —Å–∏–º—É–ª—è—Ü–∏—è
  startPayBtn?.addEventListener('click', () => {
    stepInit.classList.add('d-none');
    stepProc.classList.remove('d-none');
    setTimeout(() => {
      stepProc.classList.add('d-none');
      step3ds.classList.remove('d-none');
    }, 1200);
  });

  cancel3dsBtn?.addEventListener('click', () => {
    closePayModal();
    showAlert('secondary', '–û–ø–ª–∞—Ç–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞.');
  });

  confirm3dsBtn?.addEventListener('click', async () => {
    try {
      step3ds.classList.add('d-none');
      stepProc.classList.remove('d-none');

      const payload = { order: currentOrder.id, amount: currentOrder.total_amount };
      const r = await fetch(`${API}/transactions/`, { method: 'POST', headers: HJSON, body: JSON.stringify(payload) });
      const data = await r.json().catch(()=>null);

      if (!r.ok) {
        closePayModal();
        showAlert('danger', data?.detail || r.statusText || '–û–ø–ª–∞—Ç–∞ –Ω–µ –ø—Ä–æ—à–ª–∞');
        payBtn.disabled = false;
        return;
      }

      closePayModal();
      showAlert('success', '–û–ø–ª–∞—Ç–∞ –ø—Ä–æ—à–ª–∞. –°–ø–∞—Å–∏–±–æ!');
      setStatusSoldUI();
    } catch (e) {
      closePayModal();
      showAlert('danger', String(e));
      payBtn.disabled = false;
      console.error(e);
    }
  });

  // –ê–≤—Ç–æ-–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
  (async () => {
    try {
      if (!TOKEN) return;
      const pending = await fetchMyPendingOrder();
      if (pending) {
        setStatusReservedUI();
        enablePayButton(pending);
      }
    } catch (e) { console.error(e); }
  })();
})();
</script>

{% endblock %}