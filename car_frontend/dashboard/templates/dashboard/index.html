{% extends "dashboard/base.html" %}
{% load static %}
{% block title %}–ì–ª–∞–≤–Ω–∞—è{% endblock %}

{% if not has_token %}
  <div class="alert alert-warning">
    –í —Å–µ—Å—Å–∏–∏ –Ω–µ—Ç API-—Ç–æ–∫–µ–Ω–∞. –ê–≤—Ç–æ—Ä–∏–∑—É–π—Å—è —á–µ—Ä–µ–∑ —Ñ–æ—Ä–º—É –≤—Ö–æ–¥–∞, —á—Ç–æ–±—ã –ø–æ—è–≤–∏–ª–∏—Å—å –∞–¥–º–∏–Ω-–¥–µ–π—Å—Ç–≤–∏—è.
  </div>
{% endif %}

{% block content %}
<div class="container py-5" style="max-width: 1200px;">

  <div class="text-center mb-5">
    <h1 class="fw-bold">
      {% if user %}
        –ü—Ä–∏–≤–µ—Ç,
        {% if user.first_name or user.last_name %}
          {{ user.first_name }} {{ user.last_name }}
        {% else %}
          {{ user.username }}
        {% endif %}
      {% else %}
        –ü—Ä–∏–≤–µ—Ç, –ì–æ—Å—Ç—å üëã
      {% endif %}
    </h1>
    <p class="text-muted mb-0">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —Å–∏—Å—Ç–µ–º—É!</p>
  </div>

  <!-- === –§–ò–õ–¨–¢–†–´ / –ü–û–ò–°–ö / –°–û–†–¢–ò–†–û–í–ö–ê === -->
  <form method="get" class="card border-0 shadow-sm mb-4">
    <div class="card-body">
      <div class="row g-3 align-items-end">

        <!-- –ü–æ–∏—Å–∫ -->
        <div class="col-md-4">
          <label for="q" class="form-label text-soft">–ü–æ–∏—Å–∫</label>
          <input type="text" class="form-control form-control-sm"
                 id="q" name="q" value="{{ request.GET.q }}"
                 placeholder="–ú–∞—Ä–∫–∞, –º–æ–¥–µ–ª—å –∏–ª–∏ VIN">
        </div>

        <!-- –°—Ç–∞—Ç—É—Å -->
        <div class="col-md-3 col-lg-2">
          <label for="status" class="form-label text-soft">–°—Ç–∞—Ç—É—Å</label>
          <select class="form-select form-select-sm" id="status" name="status">
            <option value="">–õ—é–±–æ–π</option>
            <option value="available"   {% if request.GET.status == 'available'   %}selected{% endif %}>–ø—Ä–æ–¥–∞—ë—Ç—Å—è</option>
            <option value="reserved"    {% if request.GET.status == 'reserved'    %}selected{% endif %}>–∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–æ</option>
            <option value="sold"        {% if request.GET.status == 'sold'        %}selected{% endif %}>–ø—Ä–æ–¥–∞–Ω–æ</option>
            <option value="unavailable" {% if request.GET.status == 'unavailable' %}selected{% endif %}>–Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ</option>
          </select>
        </div>

        <!-- –ì–æ–¥ –æ—Ç/–¥–æ -->
        <div class="col-6 col-md-2 col-lg-1">
          <label for="year_min" class="form-label text-soft">–ì–æ–¥ ‚â•</label>
          <input type="number" min="1950" max="2100"
                 class="form-control form-control-sm"
                 id="year_min" name="year_min" value="{{ request.GET.year_min }}">
        </div>
        <div class="col-6 col-md-2 col-lg-1">
          <label for="year_max" class="form-label text-soft">–ì–æ–¥ ‚â§</label>
          <input type="number" min="1950" max="2100"
                 class="form-control form-control-sm"
                 id="year_max" name="year_max" value="{{ request.GET.year_max }}">
        </div>

        <!-- –¶–µ–Ω–∞ –æ—Ç/–¥–æ -->
        <div class="col-6 col-md-2 col-lg-1">
          <label for="price_min" class="form-label text-soft">–¶–µ–Ω–∞ ‚â•</label>
          <input type="number" min="0" step="1000"
                 class="form-control form-control-sm"
                 id="price_min" name="price_min" value="{{ request.GET.price_min }}">
        </div>
        <div class="col-6 col-md-2 col-lg-1">
          <label for="price_max" class="form-label text-soft">–¶–µ–Ω–∞ ‚â§</label>
          <input type="number" min="0" step="1000"
                 class="form-control form-control-sm"
                 id="price_max" name="price_max" value="{{ request.GET.price_max }}">
        </div>

        <!-- –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ -->
        <div class="col-md-3 col-lg-2">
          <label for="sort" class="form-label text-soft">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</label>
          <select class="form-select form-select-sm" id="sort" name="sort">
            <option value="" {% if not request.GET.sort %}selected{% endif %}>–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é</option>
            <option value="new"        {% if request.GET.sort == 'new'        %}selected{% endif %}>–°–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ</option>
            <option value="old"        {% if request.GET.sort == 'old'        %}selected{% endif %}>–°–Ω–∞—á–∞–ª–∞ —Å—Ç–∞—Ä—ã–µ</option>
            <option value="price_asc"  {% if request.GET.sort == 'price_asc'  %}selected{% endif %}>–¶–µ–Ω–∞ ‚Üë</option>
            <option value="price_desc" {% if request.GET.sort == 'price_desc' %}selected{% endif %}>–¶–µ–Ω–∞ ‚Üì</option>
            <option value="year_desc"  {% if request.GET.sort == 'year_desc'  %}selected{% endif %}>–ì–æ–¥ ‚Üì</option>
            <option value="year_asc"   {% if request.GET.sort == 'year_asc'   %}selected{% endif %}>–ì–æ–¥ ‚Üë</option>
          </select>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∏ -->
        <div class="col-md-3 col-lg-2 d-grid">
          <button type="submit" class="btn btn-primary btn-sm">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        </div>
        <div class="col-md-3 col-lg-2 d-grid">
          <a href="{% url 'users_dashboard' %}" class="btn btn-outline-secondary btn-sm">–°–±—Ä–æ—Å–∏—Ç—å</a>
        </div>
      </div>

      <!-- –ê–∫—Ç–∏–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã-–ø–∏–ª—é–ª–∏ -->
      {% with p=request.GET %}
      {% if p.q or p.status or p.year_min or p.year_max or p.price_min or p.price_max or p.sort %}
        <div class="mt-3 d-flex flex-wrap gap-2">
          {% if p.q %}
            <a class="badge rounded-pill bg-info text-dark text-decoration-none" href="?{{ qs_no_q }}">–ø–æ–∏—Å–∫: ‚Äú{{ p.q }}‚Äù ‚úï</a>
          {% endif %}
          {% if p.status %}
            <a class="badge rounded-pill bg-secondary text-decoration-none" href="?{{ qs_no_status }}">—Å—Ç–∞—Ç—É—Å: {{ p.status }} ‚úï</a>
          {% endif %}
          {% if p.year_min %}
            <a class="badge rounded-pill bg-secondary text-decoration-none" href="?{{ qs_no_year_min }}">–≥–æ–¥ ‚â• {{ p.year_min }} ‚úï</a>
          {% endif %}
          {% if p.year_max %}
            <a class="badge rounded-pill bg-secondary text-decoration-none" href="?{{ qs_no_year_max }}">–≥–æ–¥ ‚â§ {{ p.year_max }} ‚úï</a>
          {% endif %}
          {% if p.price_min %}
            <a class="badge rounded-pill bg-secondary text-decoration-none" href="?{{ qs_no_price_min }}">—Ü–µ–Ω–∞ ‚â• {{ p.price_min }} ‚úï</a>
          {% endif %}
          {% if p.price_max %}
            <a class="badge rounded-pill bg-secondary text-decoration-none" href="?{{ qs_no_price_max }}">—Ü–µ–Ω–∞ ‚â§ {{ p.price_max }} ‚úï</a>
          {% endif %}
          {% if p.sort %}
            <a class="badge rounded-pill bg-secondary text-decoration-none" href="?{{ qs_no_sort }}">—Å–æ—Ä—Ç: {{ p.sort }} ‚úï</a>
          {% endif %}
        </div>
      {% endif %}
      {% endwith %}
    </div>
  </form>

  {% if cars %}
    <div class="row g-4">
      {% for car in cars %}
        <div class="col-12">
          <div class="card border-0 shadow-lg overflow-hidden">
            <!-- –ù–æ–≤–∞—è —Ä–æ–≤–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ -->
            <article class="car-card2">
              <!-- –§–æ—Ç–æ (–∫–∞—Ä—É—Å–µ–ª—å) -->
              <div class="car2-media">
                <div id="carCarousel_{{ car.VIN }}" class="carousel slide" data-bs-interval="0">
                  <div class="carousel-inner">
                    {% if car.images and car.images|length > 0 %}
                      {% for url in car.images %}
                        <div class="carousel-item {% if forloop.first %}active{% endif %}">
                          <img src="{{ url }}" alt="–§–æ—Ç–æ {{ car.VIN }}" class="car2-img"
                               onerror="this.onerror=null;this.src='{% static 'img/default.png' %}'">
                        </div>
                      {% endfor %}
                    {% else %}
                      <div class="carousel-item active">
                        <img src="{% static 'img/default.png' %}" alt="–ù–µ—Ç —Ñ–æ—Ç–æ" class="car2-img">
                      </div>
                    {% endif %}
                  </div>

                  {% if car.images and car.images|length > 1 %}
                    <button class="carousel-control-prev" type="button"
                            data-bs-target="#carCarousel_{{ car.VIN }}" data-bs-slide="prev">
                      <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                      <span class="visually-hidden">–ù–∞–∑–∞–¥</span>
                    </button>
                    <button class="carousel-control-next" type="button"
                            data-bs-target="#carCarousel_{{ car.VIN }}" data-bs-slide="next">
                      <span class="carousel-control-next-icon" aria-hidden="true"></span>
                      <span class="visually-hidden">–í–ø–µ—Ä—ë–¥</span>
                    </button>
                  {% endif %}
                </div>

                <span class="car2-status badge
                  {% if car.status == 'available' %}bg-success
                  {% elif car.status == 'reserved' %}bg-warning text-dark
                  {% elif car.status == 'sold' %}bg-danger
                  {% else %}bg-secondary{% endif %}">
                  {{ car.status_ru }}
                </span>

                {% if car.images and car.images|length > 1 %}
                  <div class="car2-counter" title="—Ñ–æ—Ç–æ">{{ car.images|length }}</div>
                {% endif %}
              </div>

              <!-- –ò–Ω—Ñ–æ -->
              <div class="car2-info">
                <header class="car2-head">
                  <h3 class="car2-title">
                    {{ car.make_name }} {{ car.model_name }}
                    {% if car.year %}<span class="car2-year">¬∑ {{ car.year }}</span>{% endif %}
                  </h3>
                  <div class="car2-price">{{ car.price_fmt }} ‚ÇΩ</div>
                </header>

                <div class="car2-sub">VIN: <span class="font-monospace">{{ car.VIN }}</span></div>

                <dl class="car2-meta">
                  <div><dt>–ü—Ä–æ–¥–∞–≤–µ—Ü (–§.–ò)</dt><dd>{{ car.seller_full_name }}</dd></div>
                  <div><dt>–°–æ–∑–¥–∞–Ω–æ</dt><dd>{{ car.created_at_fmt }}</dd></div>
                </dl>

                <div class="car2-desc">
                  {{ car.description|default:"‚Äî" }}
                </div>

                <div class="car2-actions">
                  <a href="{% url 'car_detail' car.VIN %}" class="btn btn-outline-secondary btn-sm">–ü–æ–¥—Ä–æ–±–Ω–µ–µ ‚Üí</a>

                  {% if user and car.status == 'available' %}
                    {% if request.session.is_admin_or_analitic %}
                      <button class="btn btn-secondary btn-sm" disabled title="–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞">
                        –†–µ–∑–µ—Ä–≤ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
                      </button>
                    {% elif user.id != car.seller %}
                      <button
                        class="btn btn-success btn-sm reserve-btn"
                        data-vin="{{ car.VIN }}"
                        data-seller="{{ car.seller }}">
                        –ó–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞—Ç—å
                      </button>
                    {% else %}
                      <button class="btn btn-secondary btn-sm" disabled title="–≠—Ç–æ –≤–∞—à –∞–≤—Ç–æ–º–æ–±–∏–ª—å">
                        –ù–µ–ª—å–∑—è —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞—Ç—å —Å–≤–æ—ë –∞–≤—Ç–æ
                      </button>
                    {% endif %}
                  {% endif %}
                </div>
              </div>
            </article>
          </div>
        </div>
      {% endfor %}
    </div>

    {% if page_obj %}
      <nav class="mt-4">
        <ul class="pagination pagination-sm">
          {% if page_obj.has_previous %}
            <li class="page-item">
              <a class="page-link" href="?{{ base_qs }}{% if base_qs %}&{% endif %}page={{ page_obj.previous_page_number }}">‚Äπ</a>
            </li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">‚Äπ</span></li>
          {% endif %}

          {% for num in page_obj.paginator.page_range %}
            {% if num == page_obj.number %}
              <li class="page-item active"><span class="page-link">{{ num }}</span></li>
            {% elif num > page_obj.number|add:-3 and num < page_obj.number|add:3 %}
              <li class="page-item">
                <a class="page-link" href="?{{ base_qs }}{% if base_qs %}&{% endif %}page={{ num }}">{{ num }}</a>
              </li>
            {% endif %}
          {% endfor %}

          {% if page_obj.has_next %}
            <li class="page-item">
              <a class="page-link" href="?{{ base_qs }}{% if base_qs %}&{% endif %}page={{ page_obj.next_page_number }}">‚Ä∫</a>
            </li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">‚Ä∫</span></li>
          {% endif %}
        </ul>
      </nav>
    {% endif %}

  {% else %}
    <div class="alert alert-secondary mt-4" role="alert">
      –ú–∞—à–∏–Ω –ø–æ–∫–∞ –Ω–µ—Ç. –°–æ–∑–¥–∞–π –ø–µ—Ä–≤–æ–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ.
    </div>
  {% endif %}

</div>

<style>
  /* –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –≤–æ –≤—Å–µ—Ö .btn */
  .btn{ display:inline-flex; align-items:center; justify-content:center; text-align:center; }

  /* ===== –†–æ–≤–Ω—ã–π –º–∞–∫–µ—Ç –∫–∞—Ä—Ç–æ—á–∫–∏, —Å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ —Ç–µ–º—ã ===== */
  .car-card2{
    display:grid; grid-template-columns: 480px 1fr; gap:24px;
    background:var(--bg-elevated); color:var(--text);
    border-radius:12px; border:1px solid var(--border); padding:24px;
  }
  @media (max-width: 992px){
    .car-card2{ grid-template-columns: 1fr; }
  }

  /* –§–æ—Ç–æ (–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ–º 16:10) */
  .car2-media{ position:relative; border-radius:10px; overflow:hidden; background:var(--bg-base); }
  .car2-media::before{ content:""; display:block; padding-top:62.5%; } /* 16/10 */

  .car2-media .carousel,
  .car2-media .carousel-inner,
  .car2-media .carousel-item{ position:absolute; inset:0; height:100%; }
  .car2-img{ width:100%; height:100%; object-fit:cover; }

  .car2-status{
    position:absolute; left:12px; top:12px;
    font-weight:700; padding:.35rem .6rem; border-radius:.6rem;
  }
  .car2-counter{
    position:absolute; right:12px; bottom:12px;
    background:rgba(0,0,0,.35); color:#fff; border:1px solid rgba(255,255,255,.2);
    padding:.25rem .5rem; border-radius:.5rem; font-size:.8rem; backdrop-filter: blur(4px);
  }

  .car2-info{ display:flex; flex-direction:column; min-width:0; }
  .car2-head{ display:flex; align-items:baseline; justify-content:space-between; gap:16px; margin-bottom:8px; }
  .car2-title{ margin:0; font-weight:800; color:var(--text); }
  .car2-year{ color:var(--text-muted); font-weight:600; margin-left:.25rem; }
  .car2-price{ font-weight:800; font-size:clamp(22px, 3.2vw, 32px); white-space:nowrap; }

  .car2-sub{ color:var(--text-muted); margin-bottom:10px; }

  .car2-meta{
    display:grid; grid-template-columns: 180px 1fr; row-gap:6px; column-gap:12px;
    margin: 8px 0 16px;
  }
  .car2-meta dt{ color:var(--text-muted); font-weight:600; }
  .car2-meta dd{ margin:0; color:var(--text); }

  .car2-desc{
    background:var(--bg-base); border:1px solid var(--border); border-radius:8px;
    color:var(--text); padding:12px; margin-top:4px;
    display:-webkit-box; -webkit-line-clamp:4; -webkit-box-orient:vertical; overflow:hidden;
  }

  .car2-actions{ margin-top:16px; display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap; }

  /* –§–æ—Ä–º—ã –ø–æ–¥ —Ç–µ–º—É */
  .form-control, .form-select{
    background:var(--bg-base); color:var(--text); border-color:var(--border);
  }
  .form-control:focus, .form-select:focus{
    border-color:var(--focus-ring-color);
    box-shadow:0 0 0 var(--focus-ring-width) var(--focus-ring-color);
  }

  .text-soft{ color:var(--text-muted)!important; }
</style>

<script>
  const MIN_W = 800, MIN_H = 450, MIN_RATIO = 1.3;
  async function checkImagesAreWide(files) {
    const arr = Array.from(files || []);
    for (const f of arr) {
      if (!/^image\//.test(f.type)) throw new Error(`–§–∞–π–ª ${f.name} –Ω–µ –ø–æ—Ö–æ–∂ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ`);
      const img = await new Promise((res, rej) => {
        const o = new Image();
        o.onload = () => res(o);
        o.onerror = () => rej(new Error(`–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å ${f.name}`));
        o.src = URL.createObjectURL(f);
      });
      const w = img.naturalWidth, h = img.naturalHeight, r = w / h;
      URL.revokeObjectURL(img.src);
      if (w < MIN_W || h < MIN_H || r < MIN_RATIO) {
        throw new Error(`–ù–µ–¥–æ–ø—É—Å—Ç–∏–º–æ–µ —Ñ–æ—Ç–æ: ${f.name}. –ù—É–∂–Ω—ã –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ ‚â• ${MIN_W}√ó${MIN_H} –∏ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ ‚â• ${MIN_RATIO}.`);
      }
    }
  }
</script>

<script>
(function () {
  const API_BASE  = "http://127.0.0.1:8000/api/v1";
  const API_TOKEN = "{{ request.session.api_token|default:'' }}";
  const ME_ID     = {{ user.id|default:'null' }};
  const IS_ADMIN_OR_ANALITIC = {{ request.session.is_admin_or_analitic|yesno:"true,false" }};

  async function apiFetch(path, options = {}) {
    if (!API_TOKEN) throw new Error("–ù–µ—Ç —Ç–æ–∫–µ–Ω–∞ –≤ —Å–µ—Å—Å–∏–∏ ‚Äî –∞–≤—Ç–æ—Ä–∏–∑—É–π—Å—è.");
    const headers = { "Authorization": "Token " + API_TOKEN, ...(options.headers || {}) };
    if (options.body && !headers["Content-Type"]) headers["Content-Type"] = "application/json";
    const r = await fetch(API_BASE + path, { ...options, headers, mode: "cors" });
    let data = null; try { data = await r.json(); } catch(e) {}
    return { ok: r.ok, status: r.status, data };
  }

  document.addEventListener('click', async (e) => {
    const btn = e.target.closest('.reserve-btn');
    if (!btn) return;

    if (IS_ADMIN_OR_ANALITIC) {
      alert('–†–µ–∑–µ—Ä–≤ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞.');
      return;
    }

    const sellerId = btn.dataset.seller;
    if (ME_ID && sellerId && String(ME_ID) === String(sellerId)) {
      alert('–≠—Ç–æ –≤–∞—à–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ. –†–µ–∑–µ—Ä–≤ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.');
      return;
    }

    const vin = btn.dataset.vin;
    btn.disabled = true; const prev = btn.textContent; btn.textContent = '–†–µ–∑–µ—Ä–≤...';
    try {
      const res = await apiFetch(`/cars/${encodeURIComponent(vin)}/reserve/`, {
        method: 'POST',
        body: JSON.stringify({})
      });
      if (res.ok) {
        alert(`–ó–∞–∫–∞–∑ #${res.data?.id ?? '‚Äî'} —Å–æ–∑–¥–∞–Ω. –ê–≤—Ç–æ –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–æ.`);
        location.reload();
      } else {
        alert(res.data?.detail || `–û—à–∏–±–∫–∞ ${res.status}`);
      }
    } catch (err) {
      alert(String(err));
    } finally {
      btn.disabled = false; btn.textContent = prev;
    }
  });
})();
</script>

{% endblock %}