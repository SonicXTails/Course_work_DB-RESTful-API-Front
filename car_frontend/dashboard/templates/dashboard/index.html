{% extends "dashboard/base.html" %}
{% load static %}
{% block title %}–ì–ª–∞–≤–Ω–∞—è{% endblock %}

{% if not has_token %}
  <div class="alert alert-warning">
    –í —Å–µ—Å—Å–∏–∏ –Ω–µ—Ç API-—Ç–æ–∫–µ–Ω–∞. –ê–≤—Ç–æ—Ä–∏–∑—É–π—Å—è —á–µ—Ä–µ–∑ —Ñ–æ—Ä–º—É –≤—Ö–æ–¥–∞, —á—Ç–æ–±—ã –ø–æ—è–≤–∏–ª–∏—Å—å –∞–¥–º–∏–Ω-–¥–µ–π—Å—Ç–≤–∏—è.
  </div>
{% endif %}

{% block content %}
<div class="container py-5" style="max-width: 1200px;">

  <div class="text-center mb-5">
    <h1 class="fw-bold">
      {% if user %}
        –ü—Ä–∏–≤–µ—Ç,
        {% if user.first_name or user.last_name %}
          {{ user.first_name }} {{ user.last_name }}
        {% else %}
          {{ user.username }}
        {% endif %}
      {% else %}
        –ü—Ä–∏–≤–µ—Ç, –ì–æ—Å—Ç—å üëã
      {% endif %}
    </h1>
    <p class="text-muted mb-0">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —Å–∏—Å—Ç–µ–º—É!</p>
  </div>

  <!-- === –§–ò–õ–¨–¢–†–´ / –ü–û–ò–°–ö / –°–û–†–¢–ò–†–û–í–ö–ê === -->
  <form method="get" class="card border-0 shadow-sm mb-4 bg-dark text-light">
    <div class="card-body">
      <div class="row g-3 align-items-end">

        <!-- –ü–æ–∏—Å–∫ -->
        <div class="col-md-4">
          <label for="q" class="form-label text-soft">–ü–æ–∏—Å–∫</label>
          <input type="text" class="form-control form-control-sm bg-body text-light border-secondary"
                 id="q" name="q" value="{{ request.GET.q }}"
                 placeholder="–ú–∞—Ä–∫–∞, –º–æ–¥–µ–ª—å –∏–ª–∏ VIN">
        </div>

        <!-- –°—Ç–∞—Ç—É—Å -->
        <div class="col-md-3 col-lg-2">
          <label for="status" class="form-label text-soft">–°—Ç–∞—Ç—É—Å</label>
          <select class="form-select form-select-sm bg-body text-light border-secondary"
                  id="status" name="status">
            <option value="">–õ—é–±–æ–π</option>
            <option value="available"   {% if request.GET.status == 'available'   %}selected{% endif %}>–ø—Ä–æ–¥–∞—ë—Ç—Å—è</option>
            <option value="reserved"    {% if request.GET.status == 'reserved'    %}selected{% endif %}>–∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–æ</option>
            <option value="sold"        {% if request.GET.status == 'sold'        %}selected{% endif %}>–ø—Ä–æ–¥–∞–Ω–æ</option>
            <option value="unavailable" {% if request.GET.status == 'unavailable' %}selected{% endif %}>–Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ</option>
          </select>
        </div>

        <!-- –ì–æ–¥ –æ—Ç/–¥–æ -->
        <div class="col-6 col-md-2 col-lg-1">
          <label for="year_min" class="form-label text-soft">–ì–æ–¥ ‚â•</label>
          <input type="number" min="1950" max="2100"
                 class="form-control form-control-sm bg-body text-light border-secondary"
                 id="year_min" name="year_min" value="{{ request.GET.year_min }}">
        </div>
        <div class="col-6 col-md-2 col-lg-1">
          <label for="year_max" class="form-label text-soft">–ì–æ–¥ ‚â§</label>
          <input type="number" min="1950" max="2100"
                 class="form-control form-control-sm bg-body text-light border-secondary"
                 id="year_max" name="year_max" value="{{ request.GET.year_max }}">
        </div>

        <!-- –¶–µ–Ω–∞ –æ—Ç/–¥–æ -->
        <div class="col-6 col-md-2 col-lg-1">
          <label for="price_min" class="form-label text-soft">–¶–µ–Ω–∞ ‚â•</label>
          <input type="number" min="0" step="1000"
                 class="form-control form-control-sm bg-body text-light border-secondary"
                 id="price_min" name="price_min" value="{{ request.GET.price_min }}">
        </div>
        <div class="col-6 col-md-2 col-lg-1">
          <label for="price_max" class="form-label text-soft">–¶–µ–Ω–∞ ‚â§</label>
          <input type="number" min="0" step="1000"
                 class="form-control form-control-sm bg-body text-light border-secondary"
                 id="price_max" name="price_max" value="{{ request.GET.price_max }}">
        </div>

        <!-- –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ -->
        <div class="col-md-3 col-lg-2">
          <label for="sort" class="form-label text-soft">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</label>
          <select class="form-select form-select-sm bg-body text-light border-secondary"
                  id="sort" name="sort">
            <option value="" {% if not request.GET.sort %}selected{% endif %}>–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é</option>
            <option value="new"        {% if request.GET.sort == 'new'        %}selected{% endif %}>–°–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ</option>
            <option value="old"        {% if request.GET.sort == 'old'        %}selected{% endif %}>–°–Ω–∞—á–∞–ª–∞ —Å—Ç–∞—Ä—ã–µ</option>
            <option value="price_asc"  {% if request.GET.sort == 'price_asc'  %}selected{% endif %}>–¶–µ–Ω–∞ ‚Üë</option>
            <option value="price_desc" {% if request.GET.sort == 'price_desc' %}selected{% endif %}>–¶–µ–Ω–∞ ‚Üì</option>
            <option value="year_desc"  {% if request.GET.sort == 'year_desc'  %}selected{% endif %}>–ì–æ–¥ ‚Üì</option>
            <option value="year_asc"   {% if request.GET.sort == 'year_asc'   %}selected{% endif %}>–ì–æ–¥ ‚Üë</option>
          </select>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∏ -->
        <div class="col-md-3 col-lg-2 d-grid">
          <button type="submit" class="btn btn-primary btn-sm">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        </div>
        <div class="col-md-3 col-lg-2 d-grid">
          <a href="{% url 'users_dashboard' %}" class="btn btn-outline-secondary btn-sm">–°–±—Ä–æ—Å–∏—Ç—å</a>
        </div>
      </div>

      <!-- –ê–∫—Ç–∏–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã-–ø–∏–ª—é–ª–∏ -->
      {% with p=request.GET %}
      {% if p.q or p.status or p.year_min or p.year_max or p.price_min or p.price_max or p.sort %}
        <div class="mt-3 d-flex flex-wrap gap-2">
          {% if p.q %}
            <a class="badge rounded-pill bg-info text-dark text-decoration-none" href="?{{ qs_no_q }}">–ø–æ–∏—Å–∫: ‚Äú{{ p.q }}‚Äù ‚úï</a>
          {% endif %}
          {% if p.status %}
            <a class="badge rounded-pill bg-secondary text-decoration-none" href="?{{ qs_no_status }}">—Å—Ç–∞—Ç—É—Å: {{ p.status }} ‚úï</a>
          {% endif %}
          {% if p.year_min %}
            <a class="badge rounded-pill bg-secondary text-decoration-none" href="?{{ qs_no_year_min }}">–≥–æ–¥ ‚â• {{ p.year_min }} ‚úï</a>
          {% endif %}
          {% if p.year_max %}
            <a class="badge rounded-pill bg-secondary text-decoration-none" href="?{{ qs_no_year_max }}">–≥–æ–¥ ‚â§ {{ p.year_max }} ‚úï</a>
          {% endif %}
          {% if p.price_min %}
            <a class="badge rounded-pill bg-secondary text-decoration-none" href="?{{ qs_no_price_min }}">—Ü–µ–Ω–∞ ‚â• {{ p.price_min }} ‚úï</a>
          {% endif %}
          {% if p.price_max %}
            <a class="badge rounded-pill bg-secondary text-decoration-none" href="?{{ qs_no_price_max }}">—Ü–µ–Ω–∞ ‚â§ {{ p.price_max }} ‚úï</a>
          {% endif %}
          {% if p.sort %}
            <a class="badge rounded-pill bg-secondary text-decoration-none" href="?{{ qs_no_sort }}">—Å–æ—Ä—Ç: {{ p.sort }} ‚úï</a>
          {% endif %}
        </div>
      {% endif %}
      {% endwith %}
    </div>
  </form>

  {% if cars %}
    <div class="row g-4">
      {% for car in cars %}
        <div class="col-12">
          <div class="card border-0 shadow-lg car-card overflow-hidden">
            <div class="row g-0 align-items-stretch">

              <!-- –§–æ—Ç–æ -->
              <div class="col-lg-5 d-flex">
                <div class="photo-frame flex-grow-1">
                  <div id="carCarousel_{{ car.VIN }}" class="carousel slide h-100" data-bs-ride="carousel">
                    <div class="carousel-inner h-100">
                      {% if car.images and car.images|length > 0 %}
                        {% for url in car.images %}
                          <div class="carousel-item {% if forloop.first %}active{% endif %} h-100">
                            <div class="photo-box">
                              <img src="{{ url }}" alt="–§–æ—Ç–æ {{ car.VIN }}" class="photo-img">
                            </div>
                          </div>
                        {% endfor %}
                      {% else %}
                        <div class="carousel-item active h-100">
                          <div class="photo-box">
                            <img src="{% static 'img/default.png' %}" alt="–ù–µ—Ç —Ñ–æ—Ç–æ" class="photo-img">
                          </div>
                        </div>
                      {% endif %}
                    </div>

                    {% if car.images and car.images|length > 1 %}
                      <button class="carousel-control-prev" type="button" data-bs-target="#carCarousel_{{ car.VIN }}" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">–ù–∞–∑–∞–¥</span>
                      </button>
                      <button class="carousel-control-next" type="button" data-bs-target="#carCarousel_{{ car.VIN }}" data-bs-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">–í–ø–µ—Ä—ë–¥</span>
                      </button>
                    {% endif %}
                  </div>
                </div>
              </div>

              <!-- –ò–Ω—Ñ–æ -->
              <div class="col-lg-7">
                <div class="p-4 p-lg-5 h-100 d-flex flex-column">
                  <div class="d-flex align-items-start justify-content-between flex-wrap gap-2 mb-3">
                    <div>
                      <h3 class="mb-1 text-emphasis">
                        {{ car.make_name }} {{ car.model_name }}
                        {% if car.year %}<span class="fw-normal text-soft">¬∑ {{ car.year }}</span>{% endif %}
                      </h3>
                      <div class="small text-soft-strong">VIN: <span class="font-monospace">{{ car.VIN }}</span></div>
                    </div>
                  </div>

                  <!-- –¶–µ–Ω–∞ –∏ —Å—Ç–∞—Ç—É—Å -->
                  <div class="mb-3">
                    <div class="display-6 fw-bold price">{{ car.price_fmt }} ‚ÇΩ</div>
                    <div class="mt-2">
                      <span class="badge
                        {% if car.status == 'available' %}bg-success
                        {% elif car.status == 'reserved' %}bg-warning text-dark
                        {% elif car.status == 'sold' %}bg-danger
                        {% else %}bg-secondary{% endif %}">
                        {{ car.status_ru }}
                      </span>
                    </div>
                  </div>

                  <!-- –ö–Ω–æ–ø–∫–∞ —Å–ø—Ä–∞–≤–∞ -->
                  <div class="text-end mb-3">
                    <a href="{% url 'car_detail' car.VIN %}" class="btn btn-outline-light btn-sm">–ü–æ–¥—Ä–æ–±–Ω–µ–µ ‚Üí</a>
                  </div>

                  {% if user and car.status == 'available' %}
                    <button
                      class="btn btn-success btn-sm reserve-btn"
                      data-vin="{{ car.VIN }}">
                      –ó–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞—Ç—å
                    </button>
                  {% endif %}

                  <dl class="row g-2 small mb-4">
                    <dt class="col-5 col-md-4 text-soft">–ü—Ä–æ–¥–∞–≤–µ—Ü (–§.–ò)</dt>
                    <dd class="col-7 col-md-8 text-plain">{{ car.seller_full_name }}</dd>

                    <dt class="col-5 col-md-4 text-soft">–°–æ–∑–¥–∞–Ω–æ</dt>
                    <dd class="col-7 col-md-8 text-plain">{{ car.created_at_fmt }}</dd>
                  </dl>

                  <div class="mt-auto">
                    <div class="text-soft mb-1">–û–ø–∏—Å–∞–Ω–∏–µ</div>
                    <div class="desc-box p-3 rounded text-plain">
                      {{ car.description|default:"‚Äî" }}
                    </div>
                  </div>
                </div>
              </div>

            </div>
          </div>
        </div>
      {% endfor %}
    </div>

    <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è (—Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã) -->
    {% if page_obj %}
      <nav class="mt-4">
        <ul class="pagination pagination-sm">
          {% if page_obj.has_previous %}
            <li class="page-item">
              <a class="page-link" href="?{{ base_qs }}{% if base_qs %}&{% endif %}page={{ page_obj.previous_page_number }}">‚Äπ</a>
            </li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">‚Äπ</span></li>
          {% endif %}

          {% for num in page_obj.paginator.page_range %}
            {% if num == page_obj.number %}
              <li class="page-item active"><span class="page-link">{{ num }}</span></li>
            {% elif num > page_obj.number|add:-3 and num < page_obj.number|add:3 %}
              <li class="page-item">
                <a class="page-link" href="?{{ base_qs }}{% if base_qs %}&{% endif %}page={{ num }}">{{ num }}</a>
              </li>
            {% endif %}
          {% endfor %}

          {% if page_obj.has_next %}
            <li class="page-item">
              <a class="page-link" href="?{{ base_qs }}{% if base_qs %}&{% endif %}page={{ page_obj.next_page_number }}">‚Ä∫</a>
            </li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">‚Ä∫</span></li>
          {% endif %}
        </ul>
      </nav>
    {% endif %}

  {% else %}
    <div class="alert alert-secondary mt-4" role="alert">
      –ú–∞—à–∏–Ω –ø–æ–∫–∞ –Ω–µ—Ç. –°–æ–∑–¥–∞–π –ø–µ—Ä–≤–æ–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ.
    </div>
  {% endif %}

</div>

<style>
  /* === –ö–∞—Ä—Ç–æ—á–∫–∞ –∞–≤—Ç–æ === */
  .car-card{ background:#1f2a36; color:#e9ecef; }
  .photo-frame{ background:#18222f; border-right:1px solid #2b3a4a; border-top-left-radius:.5rem; border-bottom-left-radius:.5rem; padding:0; display:flex; height:100%; }
  .photo-box{ position:relative; width:100%; height:100%; background:#18222f; border-radius:.5rem; overflow:hidden; display:flex; align-items:center; justify-content:center; aspect-ratio:16/9; }
  .carousel, .carousel-inner, .carousel-item{ height:100%; }
  .photo-img{ width:100%; height:100%; object-fit:contain; display:block; }
  @media (min-width:992px){ .photo-box{ aspect-ratio:auto; height:380px; } .photo-img{ object-fit:cover; } }
  .text-soft{ color:#aebacf!important; }
  .text-soft-strong{ color:#c8d3e0!important; }
  .text-plain{ color:#eef3f9!important; }
  .text-emphasis{ color:#f6f9ff!important; }
  .desc-box{ background:#18222f; border:1px solid #2b3a4a; color:#eef3f9!important; display:-webkit-box; -webkit-line-clamp:6; -webkit-box-orient:vertical; overflow:hidden; word-break:break-word; overflow-wrap:anywhere; white-space:normal; }
  .price{ line-height:1; }
  .bg-body { background:#18222f!important; }
  .form-control, .form-select { color:#eef3f9!important; }
  .form-control:focus, .form-select:focus { border-color:#42556b; box-shadow:none; }
  .card.bg-dark { background:#1f2a36; }
</style>

<script>
  const MIN_W = 800, MIN_H = 450, MIN_RATIO = 1.3;
  async function checkImagesAreWide(files) {
    const arr = Array.from(files || []);
    for (const f of arr) {
      if (!/^image\//.test(f.type)) throw new Error(`–§–∞–π–ª ${f.name} –Ω–µ –ø–æ—Ö–æ–∂ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ`);
      const img = await new Promise((res, rej) => {
        const o = new Image();
        o.onload = () => res(o);
        o.onerror = () => rej(new Error(`–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å ${f.name}`));
        o.src = URL.createObjectURL(f);
      });
      const w = img.naturalWidth, h = img.naturalHeight, r = w / h;
      URL.revokeObjectURL(img.src);
      if (w < MIN_W || h < MIN_H || r < MIN_RATIO) {
        throw new Error(`–ù–µ–¥–æ–ø—É—Å—Ç–∏–º–æ–µ —Ñ–æ—Ç–æ: ${f.name}. –ù—É–∂–Ω—ã –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ ‚â• ${MIN_W}√ó${MIN_H} –∏ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ ‚â• ${MIN_RATIO}.`);
      }
    }
  }
</script>

<script>
(function () {
  const API_BASE  = "http://127.0.0.1:8000/api/v1";
  const API_TOKEN = "{{ request.session.api_token|default:'' }}";

  async function apiFetch(path, options = {}) {
    if (!API_TOKEN) throw new Error("–ù–µ—Ç —Ç–æ–∫–µ–Ω–∞ –≤ —Å–µ—Å—Å–∏–∏ ‚Äî –∞–≤—Ç–æ—Ä–∏–∑—É–π—Å—è.");
    const headers = { "Authorization": "Token " + API_TOKEN, ...(options.headers || {}) };
    if (options.body && !headers["Content-Type"]) headers["Content-Type"] = "application/json";
    const r = await fetch(API_BASE + path, { ...options, headers, mode: "cors" });
    let data = null; try { data = await r.json(); } catch(e) {}
    return { ok: r.ok, status: r.status, data };
  }

  document.addEventListener('click', async (e) => {
    const btn = e.target.closest('.reserve-btn');
    if (!btn) return;

    const vin = btn.dataset.vin;
    btn.disabled = true; const prev = btn.textContent; btn.textContent = '–†–µ–∑–µ—Ä–≤...';
    try {
      const res = await apiFetch(`/cars/${encodeURIComponent(vin)}/reserve/`, {
        method: 'POST',
        body: JSON.stringify({})
      });
      if (res.ok) {
        alert(`–ó–∞–∫–∞–∑ #${res.data?.id ?? '‚Äî'} —Å–æ–∑–¥–∞–Ω. –ê–≤—Ç–æ –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–æ.`);
        location.reload();
      } else {
        alert(res.data?.detail || `–û—à–∏–±–∫–∞ ${res.status}`);
      }
    } catch (err) {
      alert(String(err));
    } finally {
      btn.disabled = false; btn.textContent = prev;
    }
  });
})();
</script>

{% endblock %}  