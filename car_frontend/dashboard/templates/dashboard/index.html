{% extends "dashboard/base.html" %}
{% block title %}–ì–ª–∞–≤–Ω–∞—è{% endblock %}

{% block content %}
<div class="container py-5" style="max-width: 1200px;">

  <div class="text-center mb-5">
    <h1 class="fw-bold">
      {% if user %}
        –ü—Ä–∏–≤–µ—Ç,
        {% if user.first_name or user.last_name %}
          {{ user.first_name }} {{ user.last_name }}
        {% else %}
          {{ user.username }}
        {% endif %}
      {% else %}
        –ü—Ä–∏–≤–µ—Ç, –ì–æ—Å—Ç—å üëã
      {% endif %}
    </h1>
    <p class="text-muted mb-0">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —Å–∏—Å—Ç–µ–º—É!</p>
  </div>

  {% if cars %}
    <div class="row g-4">
      {% for car in cars %}
        <div class="col-12">
          <div class="card border-0 shadow-lg car-card overflow-hidden">
            <div class="row g-0 align-items-stretch">

              <!-- –§–æ—Ç–æ -->
              <div class="col-lg-5 d-flex">
                <div class="photo-frame flex-grow-1">
                  <div id="carCarousel_{{ car.VIN }}" class="carousel slide h-100" data-bs-ride="carousel">
                    <div class="carousel-inner h-100">
                      {% if car.images and car.images|length > 0 %}
                        {% for url in car.images %}
                          <div class="carousel-item {% if forloop.first %}active{% endif %} h-100">
                            <div class="photo-box">
                              <img src="{{ url }}" alt="–§–æ—Ç–æ {{ car.VIN }}" class="photo-img">
                            </div>
                          </div>
                        {% endfor %}
                      {% else %}
                        <div class="carousel-item active h-100">
                          <div class="photo-box">
                            <img src="/static/img/default.png" alt="–ù–µ—Ç —Ñ–æ—Ç–æ" class="photo-img">
                          </div>
                        </div>
                      {% endif %}
                    </div>

                    {% if car.images and car.images|length > 1 %}
                      <button class="carousel-control-prev" type="button" data-bs-target="#carCarousel_{{ car.VIN }}" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">–ù–∞–∑–∞–¥</span>
                      </button>
                      <button class="carousel-control-next" type="button" data-bs-target="#carCarousel_{{ car.VIN }}" data-bs-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">–í–ø–µ—Ä—ë–¥</span>
                      </button>
                    {% endif %}
                  </div>
                </div>
              </div>

              <!-- –ò–Ω—Ñ–æ -->
              <div class="col-lg-7">
                <div class="p-4 p-lg-5 h-100 d-flex flex-column">
                  <div class="d-flex align-items-start justify-content-between flex-wrap gap-2 mb-3">
                    <div>
                      <h3 class="mb-1 text-emphasis">
                        {{ car.make_name }} {{ car.model_name }}
                        {% if car.year %}<span class="fw-normal text-soft">¬∑ {{ car.year }}</span>{% endif %}
                      </h3>
                      <div class="small text-soft-strong">
                        VIN: <span class="font-monospace">{{ car.VIN }}</span>
                      </div>
                    </div>
                    <div class="text-end">
                      <div class="display-6 fw-bold price">{{ car.price }} ‚ÇΩ</div>
                      <span class="badge
                        {% if car.status == 'available' %}bg-success
                        {% elif car.status == 'reserved' %}bg-warning text-dark
                        {% elif car.status == 'sold' %}bg-danger
                        {% else %}bg-secondary{% endif %}">
                        {{ car.status }}
                      </span>
                    </div>
                  </div>

                  <dl class="row g-2 small mb-4">
                    <dt class="col-5 col-md-4 text-soft">–ü—Ä–æ–¥–∞–≤–µ—Ü (ID)</dt>
                    <dd class="col-7 col-md-8 text-plain">{{ car.seller }}</dd>

                    <dt class="col-5 col-md-4 text-soft">–°–æ–∑–¥–∞–Ω–æ</dt>
                    <dd class="col-7 col-md-8 text-plain">{{ car.created_at }}</dd>
                  </dl>

                  <div class="mt-auto">
                    <div class="text-soft mb-1">–û–ø–∏—Å–∞–Ω–∏–µ</div>
                    <div class="desc-box p-3 rounded text-plain">
                      {{ car.description|default:"‚Äî" }}
                    </div>
                  </div>
                </div>
              </div>

            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="alert alert-secondary mt-4" role="alert">
      –ú–∞—à–∏–Ω –ø–æ–∫–∞ –Ω–µ—Ç. –°–æ–∑–¥–∞–π –ø–µ—Ä–≤–æ–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ.
    </div>
  {% endif %}

</div>

<style>
  /* === –ö–∞—Ä—Ç–æ—á–∫–∞ –∞–≤—Ç–æ === */
  .car-card{
    background:#1f2a36;
    color:#e9ecef;
  }

  /* === –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ (–µ–¥–∏–Ω—ã–π —Ñ–æ–Ω) === */
  .photo-frame{
    background:#18222f;
    border-right:1px solid #2b3a4a;
    border-top-left-radius:.5rem;
    border-bottom-left-radius:.5rem;
    padding:0;
    display:flex;
    height:100%;
  }

  /* === –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ñ–æ—Ç–æ === */
  .photo-box{
    position:relative;
    width:100%;
    height:100%;
    background:#18222f;
    border-radius:.5rem;
    overflow:hidden;
    display:flex;
    align-items:center;
    justify-content:center;
    aspect-ratio:16/9;                      /* –º–æ–±–∏–ª–∫–∏/–ø–ª–∞–Ω—à–µ—Ç—ã */
  }

  /* –ö–∞—Ä—É—Å–µ–ª—å —Ç—è–Ω–µ—Ç –≤—ã—Å–æ—Ç—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
  .carousel,
  .carousel-inner,
  .carousel-item{ height:100%; }

  /* –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ */
  .photo-img{
    width:100%;
    height:100%;
    object-fit:contain;                     /* –±–µ–∑ –∫—Ä–æ–ø–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
    display:block;
  }

  /* –î–µ—Å–∫—Ç–æ–ø—ã: —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –∏ cover */
  @media (min-width:992px){
    .photo-box{
      aspect-ratio:auto;
      height:380px;
    }
    .photo-img{ object-fit:cover; }
  }

  /* === –¢–µ–∫—Å—Ç–æ–≤—ã–µ —Ü–≤–µ—Ç–∞ === */
  .text-soft{        color:#aebacf!important; }
  .text-soft-strong{ color:#c8d3e0!important; }
  .text-plain{       color:#eef3f9!important; }
  .text-emphasis{    color:#f6f9ff!important; }

  /* === –ë–ª–æ–∫ –æ–ø–∏—Å–∞–Ω–∏—è === */
  .desc-box{
    background:#18222f;
    border:1px solid #2b3a4a;
    color:#eef3f9!important;
    display:-webkit-box;
    -webkit-line-clamp:6;
    -webkit-box-orient:vertical;
    overflow:hidden;
    word-break:break-word;
    overflow-wrap:anywhere;
    white-space:normal;
  }

  .price{ line-height:1; }
</style>

<script>
  // –î–æ–ø—É—Å—Ç–∏–º —Ç–æ–ª—å–∫–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ ‚â•800√ó450 –∏ aspect ‚â• 1.3
  const MIN_W = 800, MIN_H = 450, MIN_RATIO = 1.3;

  async function checkImagesAreWide(files) {
    const arr = Array.from(files || []);
    for (const f of arr) {
      // –±—ã—Å—Ç—Ä—ã–π —á–µ–∫ –ø–æ —Ç–∏–ø—É
      if (!/^image\//.test(f.type)) throw new Error(`–§–∞–π–ª ${f.name} –Ω–µ –ø–æ—Ö–æ–∂ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ`);
      const img = await new Promise((res, rej) => {
        const o = new Image();
        o.onload = () => res(o);
        o.onerror = () => rej(new Error(`–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å ${f.name}`));
        o.src = URL.createObjectURL(f);
      });
      const w = img.naturalWidth, h = img.naturalHeight, r = w / h;
      URL.revokeObjectURL(img.src);
      if (w < MIN_W || h < MIN_H || r < MIN_RATIO) {
        throw new Error(
          `–ù–µ–¥–æ–ø—É—Å—Ç–∏–º–æ–µ —Ñ–æ—Ç–æ: ${f.name}. –ù—É–∂–Ω—ã –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ ‚â• ${MIN_W}√ó${MIN_H} –∏ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ ‚â• ${MIN_RATIO}.`
        );
      }
    }
  }

  photosInput?.addEventListener('change', async () => {
    photosPreview.innerHTML = '';
    const files = Array.from(photosInput.files || []);
    try {
      if (files.length > 10) throw new Error('–ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –Ω–µ –±–æ–ª–µ–µ 10 —Ñ–æ—Ç–æ');
      await checkImagesAreWide(files);  // ‚Üê –Ω–æ–≤—ã–π –∂—ë—Å—Ç–∫–∏–π —á–µ–∫

      // –ø—Ä–µ–≤—å—é (–∫–∞–∫ –±—ã–ª–æ)
      files.forEach(f => {
        const url = URL.createObjectURL(f);
        const wrap = document.createElement('div');
        wrap.className = 'thumb';
        wrap.innerHTML = `<img src="${url}" alt=""><div style="font-size:.75rem" class="mt-1">${f.name.slice(0,12)}</div>`;
        photosPreview.appendChild(wrap);
      });
    } catch (e) {
      showAlert('warning', String(e));
      photosInput.value = '';
    }
  });
</script>

{% endblock %}