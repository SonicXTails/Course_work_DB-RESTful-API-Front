{% extends "dashboard/base.html" %}
{% load static humanize %}
{% block title %}–ü—Ä–æ—Ñ–∏–ª—å{% endblock %}
{% block flash_messages %}{% endblock %}

{% block content %}
<div class="container py-5" style="max-width: 860px;">

  <div class="d-flex align-items-center justify-content-between mb-4">
    <h2 class="mb-0">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h2>
    <button id="createCarBtn" type="button" class="btn btn-success"
            data-bs-toggle="modal" data-bs-target="#createCarModal">
      + –°–æ–∑–¥–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ
    </button>
  </div>

  <hr class="my-5">

  <div class="card border-0 shadow" style="background:#1f2a36;color:#e9ecef;">
    <div class="card-header" style="background:#243141;border-bottom:1px solid #2f3c4e;">
      <strong>–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</strong>
      <small class="text-secondary ms-2">–ü—Ä–∏–≤–µ—Ç, {{ user.username }}</small>
    </div>
    <div class="card-body">
      {% if form.non_field_errors %}
        <div class="alert alert-danger mb-4" role="alert">
          <ul class="mb-0">
            {% for err in form.non_field_errors %}<li>{{ err }}</li>{% endfor %}
          </ul>
        </div>
      {% endif %}

      <form method="post" id="profileForm" class="needs-validation" novalidate>
        {% csrf_token %}
        <div class="row g-3">
          <div class="col-12">
            <label class="form-label">–õ–æ–≥–∏–Ω</label>
            {{ form.username }}
            {% if form.username.errors %}
              <div class="invalid-feedback d-block">{{ form.username.errors|join:", " }}</div>
            {% endif %}
          </div>
          <div class="col-md-6">
            <label class="form-label">–ò–º—è</label>
            {{ form.first_name }}
            {% if form.first_name.errors %}
              <div class="invalid-feedback d-block">{{ form.first_name.errors|join:", " }}</div>
            {% endif %}
          </div>
          <div class="col-md-6">
            <label class="form-label">–§–∞–º–∏–ª–∏—è</label>
            {{ form.last_name }}
            {% if form.last_name.errors %}
              <div class="invalid-feedback d-block">{{ form.last_name.errors|join:", " }}</div>
            {% endif %}
          </div>
          <div class="col-12">
            <label class="form-label">Email</label>
            {{ form.email }}
            {% if form.email.errors %}
              <div class="invalid-feedback d-block">{{ form.email.errors|join:", " }}</div>
            {% endif %}
          </div>
        </div>

        <div class="d-flex gap-2 mt-4">
          <button type="submit" id="saveBtn" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <button type="reset" id="resetBtn" class="btn btn-outline-light">–°–±—Ä–æ—Å–∏—Ç—å</button>
        </div>
      </form>
    </div>
  </div>

  <hr class="my-5">

  <h4 class="mb-3">–ú–æ–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è</h4>
  {% if my_cars %}
    <div class="list-group" id="myCarsList">
      {% for car in my_cars %}
        <div class="list-group-item d-flex align-items-center gap-3"
             style="background:#18222f;color:#eef3f9;border:1px solid #2b3a4a;"
             data-vin="{{ car.VIN }}"
             data-year="{{ car.year }}"
             data-price="{{ car.price }}"
             data-status="{{ car.status }}"
             data-description="{{ car.description|default_if_none:''|escape }}">
          <img src="{{ car.images|first }}"
               alt="img"
               onerror="this.onerror=null;this.src='{% static 'img/default.png' %}';"
               style="width:84px;height:56px;object-fit:cover;border-radius:.5rem;border:1px solid #2b3a4a;">
          <div class="flex-grow-1">
            <div class="fw-semibold">
              {{ car.make_name }} {{ car.model_name }}{% if car.year %} ¬∑ {{ car.year }}{% endif %}
            </div>
            <div class="small text-muted">
              VIN: <span class="font-monospace">{{ car.VIN }}</span>
            </div>
          </div>
          <div class="text-end me-2">
            <div class="fw-bold">{{ car.price_fmt }} ‚ÇΩ</div>
            <span class="badge
              {% if car.status == 'available' %}bg-success
              {% elif car.status == 'reserved' %}bg-warning text-dark
              {% elif car.status == 'sold' %}bg-danger
              {% else %}bg-secondary{% endif %}">
              {{ car.status_ru }}
            </span>
          </div>
          <div class="d-flex gap-2">
            <button class="btn btn-sm btn-outline-light car-edit">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
            <button class="btn btn-sm btn-outline-danger car-del">–£–¥–∞–ª–∏—Ç—å</button>
            {% if car.status == 'reserved' %}
              <button class="btn btn-sm btn-outline-warning seller-cancel"
                      title="–û—Ç–º–µ–Ω–∏—Ç—å PENDING-–∑–∞–∫–∞–∑ –¥–ª—è —ç—Ç–æ–≥–æ –∞–≤—Ç–æ">–û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑</button>
            {% endif %}
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="alert alert-secondary">–£ —Ç–µ–±—è –ø–æ–∫–∞ –Ω–µ—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏–π. –°–æ–∑–¥–∞–π –ø–µ—Ä–≤–æ–µ üëÜ</div>
  {% endif %}

  <hr class="my-5">

  <h4 class="mb-3">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</h4>
  <div id="favEmpty" class="alert alert-secondary d-none">–£ —Ç–µ–±—è –ø–æ–∫–∞ –Ω–µ—Ç –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö –∞–≤—Ç–æ.</div>
  <div class="list-group" id="favList"></div>
</div>

<div class="modal fade" id="createCarModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content" style="background:#1f2a36;color:#e9ecef;">
      <div class="modal-header">
        <h5 class="modal-title">–ù–æ–≤–æ–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="carFormAlert" class="alert d-none" role="alert"></div>
        <form id="carCreateForm" novalidate>
          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label">VIN</label>
              <input name="VIN" class="form-control" maxlength="17" required placeholder="17 —Å–∏–º–≤–æ–ª–æ–≤">
            </div>
            <div class="col-md-4">
              <label class="form-label">–ú–∞—Ä–∫–∞</label>
              <input name="make_name" class="form-control" list="makesList" placeholder="–í–≤–µ–¥–∏ –∏–ª–∏ –≤—ã–±–µ—Ä–∏ –º–∞—Ä–∫—É" required>
              <datalist id="makesList"></datalist>
              <div class="form-text">–ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –∏–∑ —Å–ø–∏—Å–∫–∞ –∏–ª–∏ –≤–≤–µ—Å—Ç–∏ –Ω–æ–≤—É—é ‚Äî —Å–æ–∑–¥–∞–¥–∏–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</div>
            </div>
            <div class="col-md-4">
              <label class="form-label">–ú–æ–¥–µ–ª—å</label>
              <input name="model_name" class="form-control" list="modelsList" placeholder="–í–≤–µ–¥–∏ –∏–ª–∏ –≤—ã–±–µ—Ä–∏ –º–æ–¥–µ–ª—å" required>
              <datalist id="modelsList"></datalist>
              <div class="form-text">–ü–æ–¥—Å–∫–∞–∑–∫–∏ –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –º–∞—Ä–∫–∏; –º–æ–∂–Ω–æ –≤–≤–µ—Å—Ç–∏ –º–æ–¥–µ–ª—å —Ä—É–∫–∞–º–∏.</div>
            </div>
            <div class="col-md-4">
              <label class="form-label">–ì–æ–¥</label>
              <input name="year" type="number" class="form-control" min="1950" max="2100" value="2020" required>
            </div>
            <div class="col-md-4">
              <label class="form-label">–¶–µ–Ω–∞</label>
              <input name="price" type="number" step="0.01" min="0" class="form-control" required>
            </div>
            <div class="col-12">
              <label class="form-label">–§–æ—Ç–æ (–¥–æ 10 —à—Ç.)</label>
              <input id="carPhotos" name="photos" type="file" class="form-control" accept="image/*" multiple>
              <div id="photosPreview" class="d-flex flex-wrap gap-2 mt-2"></div>
            </div>
            <div class="col-12">
              <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
              <textarea name="description" class="form-control" rows="3"></textarea>
            </div>
          </div>
          <div class="d-flex gap-2 mt-4">
            <button type="submit" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å</button>
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="editCarModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content" style="background:#1f2a36;color:#e9ecef;">
      <div class="modal-header">
        <h5 class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="carEditAlert" class="alert d-none" role="alert"></div>
        <form id="carEditForm" novalidate>
          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label">VIN</label>
              <input name="VIN" class="form-control" readonly>
            </div>
            <div class="col-md-4">
              <label class="form-label">–ì–æ–¥</label>
              <input name="year" type="number" class="form-control" min="1950" max="2100" required>
            </div>
            <div class="col-md-4">
              <label class="form-label">–¶–µ–Ω–∞</label>
              <input name="price" type="number" step="0.01" min="0" class="form-control" required>
            </div>
            <div class="col-md-4">
              <label class="form-label">–°—Ç–∞—Ç—É—Å</label>
              <select name="status" class="form-select">
                <option value="available">–ø—Ä–æ–¥–∞—ë—Ç—Å—è</option>
                <option value="unavailable">–Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ</option>
              </select>
            </div>
            <div class="col-12">
              <label class="form-label">–§–æ—Ç–æ (–¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ, –¥–æ 10 —à—Ç.)</label>
              <input id="carPhotosEdit" name="photos" type="file" class="form-control" accept="image/*" multiple>
            </div>
            <div class="col-12">
              <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
              <textarea name="description" class="form-control" rows="3"></textarea>
            </div>
          </div>
          <div class="d-flex gap-2 mt-4">
            <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<style>
  .invalid-feedback.d-block { color:#f8d7da; }
  #photosPreview .thumb { width:96px;text-align:center;border:1px solid #2b3a4a;border-radius:.5rem;padding:.25rem;background:#18222f; }
  #photosPreview img { width:90px;height:90px;object-fit:cover;border-radius:.5rem; }

  :root{
    --selection-bg: #4c8bf5;
    --selection-fg: #0b1422;
  }

  ::selection {
    background: var(--selection-bg);
    color: var(--selection-fg);
  }
  ::-moz-selection {
    background: var(--selection-bg);
    color: var(--selection-fg);
  }

  input::selection,
  textarea::selection {
    background: var(--selection-bg);
    color: #ffffff;
  }
  input::-moz-selection,
  textarea::-moz-selection {
    background: var(--selection-bg);
    color: #ffffff;
  }

  .form-text { color:#a9b7c6; }

  input.form-control:focus,
  textarea.form-control:focus,
  select.form-select:focus {
    border-color: #4c8bf5;
    box-shadow: 0 0 0 .2rem rgba(76,139,245,.25);
    outline: 0;
  }
</style>

<script>
(function () {
  const API = "http://127.0.0.1:8000/api/v1";
  const TOKEN = "{{ request.session.api_token|default:'' }}";
  if (!TOKEN) console.warn("–ù–µ—Ç API —Ç–æ–∫–µ–Ω–∞ –≤ —Å–µ—Å—Å–∏–∏");
  const H_JSON = { "Authorization": "Token " + TOKEN, "Content-Type": "application/json" };
  const H_AUTH = { "Authorization": "Token " + TOKEN };

  const pf = document.getElementById('profileForm');
  const saveBtn = document.getElementById('saveBtn');
  if (pf && saveBtn) {
    const init = new FormData(pf);
    const isDirty = () => {
      const now = new FormData(pf);
      for (const [k, v] of now.entries()) if (v !== (init.get(k) ?? "")) return true;
      return false;
    };
    const toggle = () => saveBtn.disabled = !isDirty();
    pf.addEventListener('input', toggle);
    pf.addEventListener('change', toggle);
    pf.addEventListener('reset', () => setTimeout(() => {
      for (const [k] of init) init.set(k, pf.elements[k]?.value ?? "");
      toggle();
    }, 0));
    toggle();
  }

  const modalCreate   = document.getElementById('createCarModal');
  const createForm    = document.getElementById('carCreateForm');
  const createAlert   = document.getElementById('carFormAlert');
  const photosInput   = document.getElementById('carPhotos');
  const photosPreview = document.getElementById('photosPreview');

  const makeInput  = createForm?.elements['make_name'];
  const modelInput = createForm?.elements['model_name'];
  const makesDL    = document.getElementById('makesList');
  const modelsDL   = document.getElementById('modelsList');

  const VIN_RE = /^[A-HJ-NPR-Z0-9]{17}$/i;

  function alertCreate(kind, html) {
    createAlert.className = `alert alert-${kind}`;
    createAlert.innerHTML = html;
    createAlert.classList.remove('d-none');
  }
  function clearCreateAlert(){ createAlert.className='alert d-none'; createAlert.textContent=''; }

  let MAKES = [];
  let MODELS = [];
  let selectedMakeId = null;

  const norm = s => (s || '').trim().toLowerCase();

  function fillMakesDatalist() {
    if (!makesDL) return;
    makesDL.innerHTML = '';
    for (const m of MAKES) {
      const opt = document.createElement('option');
      opt.value = m.name;
      makesDL.appendChild(opt);
    }
  }

  function fillModelsDatalist(makeId) {
    if (!modelsDL) return;
    modelsDL.innerHTML = '';
    if (!makeId) return;
    for (const md of MODELS.filter(x => String(x.make) === String(makeId))) {
      const opt = document.createElement('option');
      opt.value = md.name;
      modelsDL.appendChild(opt);
    }
  }

  function findMakeByName(name) {
    const n = norm(name);
    return MAKES.find(m => norm(m.name) === n) || null;
  }
  function findModelByNameForMake(modelName, makeId) {
    const n = norm(modelName);
    return MODELS.find(md => String(md.make) === String(makeId) && norm(md.name) === n) || null;
  }

  async function fetchCatalog() {
    const [mk, md] = await Promise.all([
      fetch(`${API}/makes/`,  { headers: H_AUTH }),
      fetch(`${API}/models/`, { headers: H_AUTH }),
    ]);
    MAKES  = mk.ok ? await mk.json() : [];
    MODELS = md.ok ? await md.json() : [];
  }

  async function ensureMakeId(name) {
    if (!name) throw new Error('–ú–∞—Ä–∫–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞');
    const exist = findMakeByName(name);
    if (exist) return exist.id;

    const r = await fetch(`${API}/makes/`, {
      method: 'POST',
      headers: { ...H_JSON },
      body: JSON.stringify({ name: name.trim() })
    });
    if (!r.ok) {
      let msg = r.statusText; try { const d = await r.json(); msg = d.detail || JSON.stringify(d) } catch {}
      throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –º–∞—Ä–∫—É: ' + msg);
    }
    const created = await r.json();
    MAKES.push(created);
    fillMakesDatalist();
    return created.id;
  }

  async function ensureModelId(name, makeId) {
    if (!name) throw new Error('–ú–æ–¥–µ–ª—å –Ω–µ —É–∫–∞–∑–∞–Ω–∞');
    const exist = findModelByNameForMake(name, makeId);
    if (exist) return exist.id;

    const r = await fetch(`${API}/models/`, {
      method: 'POST',
      headers: { ...H_JSON },
      body: JSON.stringify({ name: name.trim(), make: makeId })
    });
    if (!r.ok) {
      let msg = r.statusText; try { const d = await r.json(); msg = d.detail || JSON.stringify(d) } catch {}
      throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –º–æ–¥–µ–ª—å: ' + msg);
    }
    const created = await r.json();
    MODELS.push(created);
    fillModelsDatalist(makeId);
    return created.id;
  }

  modalCreate?.addEventListener('show.bs.modal', async () => {
    try {
      if (!MAKES.length || !MODELS.length) {
        await fetchCatalog();
      }
      fillMakesDatalist();

      selectedMakeId = null;
      if (modelInput) { modelInput.value = ''; }
      if (modelsDL) modelsDL.innerHTML = '';

      if (makeInput) {
        makeInput.oninput = null;
        makeInput.addEventListener('input', () => {
          const found = findMakeByName(makeInput.value);
          selectedMakeId = found ? found.id : null;
          fillModelsDatalist(selectedMakeId);
        });
      }

      if (modelInput) {
        modelInput.onfocus = null;
        modelInput.addEventListener('focus', () => {
          fillModelsDatalist(selectedMakeId);
        });
      }
    } catch {
      alertCreate('danger', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–∞—Ä–∫–∏/–º–æ–¥–µ–ª–∏');
    }
  });

  photosInput?.addEventListener('change', () => {
    if (!photosPreview) return;
    photosPreview.innerHTML = '';
    const files = Array.from(photosInput.files || []);
    if (files.length > 10) { alertCreate('warning', '–î–æ 10 —Ñ–æ—Ç–æ'); photosInput.value=''; return; }
    for (const f of files) {
      const url = URL.createObjectURL(f);
      const w = document.createElement('div'); w.className='thumb';
      w.innerHTML = `<img src="${url}" alt=""><div class="mt-1" style="font-size:.75rem">${f.name.slice(0,12)}</div>`;
      photosPreview.appendChild(w);
    }
  });

  async function uploadPhotos(vin, files) {
    if (!files?.length) return;
    const fd = new FormData();
    if (files.length > 10) throw new Error('–ú–∞–∫—Å–∏–º—É–º 10 —Ñ–æ—Ç–æ');
    for (const f of files) {
      if (f.size > 8*1024*1024) throw new Error(`–°–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π —Ñ–∞–π–ª: ${f.name}`);
      fd.append('files', f);
    }
    const r = await fetch(`${API}/cars/${encodeURIComponent(vin)}/images/`, { method:'POST', headers: H_AUTH, body: fd });
    if (!r.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ');
  }

  createForm?.addEventListener('submit', async (e) => {
    e.preventDefault(); clearCreateAlert();

    const vin       = createForm.elements['VIN'].value.trim().toUpperCase();
    const makeName  = makeInput?.value.trim();
    const modelName = modelInput?.value.trim();
    const year      = Number(createForm.elements['year'].value);
    const price     = String(createForm.elements['price'].value);
    const desc      = createForm.elements['description'].value.trim();

    if (!VIN_RE.test(vin)) return alertCreate('warning','VIN: 17 —Å–∏–º–≤–æ–ª–æ–≤ [A-H J-N P-R Z 0-9], –±–µ–∑ I/O/Q');
    if (!makeName)   return alertCreate('warning','–£–∫–∞–∂–∏ –º–∞—Ä–∫—É');
    if (!modelName)  return alertCreate('warning','–£–∫–∞–∂–∏ –º–æ–¥–µ–ª—å');

    try {
      const makeId  = await ensureMakeId(makeName);
      const modelId = await ensureModelId(modelName, makeId);

      const fd = new FormData();
      fd.append('VIN', vin);
      fd.append('make', String(makeId));
      fd.append('model', String(modelId));
      fd.append('year', String(year));
      fd.append('price', price);
      fd.append('description', desc);

      const res = await fetch(`${API}/cars/`, { method:'POST', headers: H_AUTH, body: fd });
      let data = null; try { data = await res.json(); } catch {}
      if (!res.ok) {
        return alertCreate('danger', data?.detail || JSON.stringify(data) || res.statusText);
      }

      try { await uploadPhotos(vin, Array.from(photosInput?.files || [])); }
      catch (err) { alertCreate('warning', `–°–æ–∑–¥–∞–Ω–æ, –Ω–æ —Ñ–æ—Ç–æ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å: ${String(err)}`); }

      alertCreate('success', '–û–±—ä—è–≤–ª–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ (VIN ' + vin + ')');
      createForm.reset(); if (photosPreview) photosPreview.innerHTML='';
      selectedMakeId = null; if (modelsDL) modelsDL.innerHTML='';
      setTimeout(() => location.reload(), 600);
    } catch (err) {
      alertCreate('danger', String(err.message || err));
    }
  });

  const list = document.getElementById('myCarsList');

  list?.addEventListener('click', async (e) => {
    const row = e.target.closest('.list-group-item'); if (!row) return;

    if (e.target.closest('.car-edit')) {
      openEdit(row);
      return;
    }

    if (e.target.closest('.car-del')) {
      if (!confirm(`–£–¥–∞–ª–∏—Ç—å VIN ${row.dataset.vin}?`)) return;
      try {
        const r = await fetch(`${API}/cars/${encodeURIComponent(row.dataset.vin)}/`, { method:'DELETE', headers: H_AUTH });
        if (r.status===204 || r.status===200) row.remove();
        else {
          let msg=`–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å (${r.status})`; try{ const d=await r.json(); if(d.detail) msg=d.detail }catch{}
          alert(msg);
        }
      } catch (err) { alert(String(err)); }
      return;
    }

    if (e.target.closest('.seller-cancel')) {
      const vin = row.dataset.vin;
      try {
        const orderId = await findPendingOrderIdByVin(vin);
        if (!orderId) {
          alert('–î–ª—è —ç—Ç–æ–π –º–∞—à–∏–Ω—ã –Ω–µ –Ω–∞–π–¥–µ–Ω PENDING-–∑–∞–∫–∞–∑.');
          return;
        }
        if (!confirm('–û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑? –ê–≤—Ç–æ —Å—Ç–∞–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã–º, –Ω–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏ –æ—Ç–º–µ–Ω—è—Ç—Å—è.')) return;

        const r = await fetch(`${API}/orders/${orderId}/seller_cancel/`, {
          method: 'POST',
          headers: H_JSON,
          body: JSON.stringify({})
        });
        let data = null; try { data = await r.json(); } catch {}
        if (!r.ok) {
          alert(data?.detail || `–û—à–∏–±–∫–∞ ${r.status}`);
          return;
        }
        alert('–ó–∞–∫–∞–∑ –æ—Ç–º–µ–Ω—ë–Ω.');
        location.reload();
      } catch (err) {
        alert(String(err));
      }
    }
  });

  // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
  const modalEdit = document.getElementById('editCarModal');
  const editForm  = document.getElementById('carEditForm');
  const editAlert = document.getElementById('carEditAlert');
  const photosEdit= document.getElementById('carPhotosEdit');

  const editMsg  = (kind, txt) => { editAlert.className=`alert alert-${kind}`; editAlert.textContent=txt; editAlert.classList.remove('d-none'); };
  const editClear= () => { editAlert.className='alert d-none'; editAlert.textContent=''; };

  function openEdit(row){
    editClear();
    editForm.VIN.value = row.dataset.vin;
    editForm.year.value = row.dataset.year || '';
    editForm.price.value = row.dataset.price || '';
    editForm.status.value = row.dataset.status || 'available';
    editForm.description.value = row.dataset.description || '';
    photosEdit.value = '';
    new bootstrap.Modal(modalEdit).show();
  }

  editForm?.addEventListener('submit', async (e) => {
    e.preventDefault(); editClear();
    const vin = editForm.VIN.value;
    const payload = {
      year: Number(editForm.year.value),
      price: editForm.price.value,
      status: editForm.status.value,
      description: editForm.description.value.trim(),
    };

    try {
      const r = await fetch(`${API}/cars/${encodeURIComponent(vin)}/`, {
        method:'PATCH', headers: H_JSON, body: JSON.stringify(payload)
      });
      if (!r.ok) {
        let msg=r.statusText; try{ const d=await r.json(); msg=d.detail||JSON.stringify(d)}catch{}
        return editMsg('danger', `–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å: ${msg}`);
      }
      try { await uploadPhotos(vin, Array.from(photosEdit.files || [])); }
      catch (err) { editMsg('warning', `–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ, –Ω–æ —Ñ–æ—Ç–æ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å: ${String(err)}`); }

      editMsg('success', '–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ ‚úî');
      setTimeout(()=>location.reload(), 500);
    } catch (err) {
      editMsg('danger', String(err));
    }
  });

  async function findPendingOrderIdByVin(vin) {
    const tryUrls = [
      `${API}/orders/?car=${encodeURIComponent(vin)}&status=pending`,
      `${API}/orders/?car=${encodeURIComponent(vin)}`
    ];
    for (const url of tryUrls) {
      try {
        const r = await fetch(url, { headers: H_AUTH });
        if (!r.ok) continue;
        const data = await r.json();
        if (Array.isArray(data)) {
          const found = data.find(o =>
            ((o.car === vin) || (o.car && (o.car.VIN === vin))) &&
            String(o.status).toLowerCase() === 'pending'
          );
          if (found) return found.id;
        }
      } catch {}
    }
    try {
      const r = await fetch(`${API}/orders/`, { headers: H_AUTH });
      if (r.ok) {
        const data = await r.json();
        if (Array.isArray(data)) {
          const found = data.find(o =>
            ((o.car === vin) || (o.car && (o.car.VIN === vin))) &&
            String(o.status).toLowerCase() === 'pending'
          );
          if (found) return found.id;
        }
      }
    } catch {}
    return null;
  }

  const favList  = document.getElementById('favList');
  const favEmpty = document.getElementById('favEmpty');

  function fmtPrice(n) {
    try {
      const i = parseInt(String(n), 10);
      return isNaN(i) ? (n ?? '‚Äî') : String(i).replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
    } catch { return n ?? '‚Äî'; }
  }

  let MAKE_MAP = null;
  let MODEL_MAP = null;

  async function ensureCatalogLoadedForFav() {
    if (MAKE_MAP && MODEL_MAP) return;
    try {
      const [mkRes, mdRes] = await Promise.all([
        fetch(`${API}/makes/`,  { headers: H_AUTH }),
        fetch(`${API}/models/`, { headers: H_AUTH }),
      ]);
      const makes  = mkRes.ok ? await mkRes.json() : [];
      const models = mdRes.ok ? await mdRes.json() : [];
      MAKE_MAP  = Object.fromEntries((makes  || []).map(m => [String(m.id), m]));
      MODEL_MAP = Object.fromEntries((models || []).map(m => [String(m.id), m]));
    } catch {
      MAKE_MAP = MAKE_MAP || {};
      MODEL_MAP = MODEL_MAP || {};
    }
  }

  function getMakeModelNames(c = {}) {
    const byNameMake  = c.make_name  || c.makeName;
    const byNameModel = c.model_name || c.modelName;
    if (byNameMake || byNameModel) return [byNameMake || '', byNameModel || ''];

    const objMake  = c.make_obj  && (c.make_obj.name  || c.make_obj.title);
    const objModel = c.model_obj && (c.model_obj.name || c.model_obj.title);
    if (objMake || objModel) return [objMake || '', objModel || ''];

    const makeId  = c.make  != null ? String(c.make)  : null;
    const modelId = c.model != null ? String(c.model) : null;
    const mapMake  = makeId  && MAKE_MAP  ? MAKE_MAP[makeId]?.name  : null;
    const mapModel = modelId && MODEL_MAP ? MODEL_MAP[modelId]?.name : null;
    return [mapMake  || (makeId  ?? '') || '', mapModel || (modelId ?? '') || ''];
  }

  function renderFav(items) {
    if (!favList) return;
    if (!items.length) {
      favList.innerHTML = '';
      favEmpty?.classList.remove('d-none');
      return;
    }
    favEmpty?.classList.add('d-none');

    favList.innerHTML = items.map(it => {
      const c = it.car_obj || {};
      const img = (Array.isArray(c.images) && c.images.length) ? c.images[0] : "{% static 'img/default.png' %}";
      const [makeName, modelName] = getMakeModelNames(c);

      const statusBadge = (s) => {
        s = String(s||'').toLowerCase();
        if (s==='available')  return '<span class="badge bg-success">–ø—Ä–æ–¥–∞—ë—Ç—Å—è</span>';
        if (s==='reserved')   return '<span class="badge bg-warning text-dark">–∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–æ</span>';
        if (s==='sold')       return '<span class="badge bg-danger">–ø—Ä–æ–¥–∞–Ω–æ</span>';
        return '<span class="badge bg-secondary">–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ</span>';
      };

      const title = `${makeName || ''} ${modelName || ''}`.trim();

      return `
        <div class="list-group-item d-flex align-items-center gap-3"
             style="background:#18222f;color:#eef3f9;border:1px solid #2b3a4a;"
             data-fav-id="${it.id}" data-vin="${c.VIN||''}">
          <img src="${img}" alt="img"
               onerror="this.onerror=null;this.src='${"{% static 'img/default.png' %}"}';"
               style="width:84px;height:56px;object-fit:cover;border-radius:.5rem;border:1px solid #2b3a4a;">
          <div class="flex-grow-1">
            <a class="fw-semibold text-decoration-none text-truncate d-inline-block"
               href="/cars/${encodeURIComponent(c.VIN||'')}/"
               style="color:#eef3f9; max-width: 420px;">
              ${title}${c.year ? ' ¬∑ ' + c.year : ''}
            </a>
            <div class="small text-muted">VIN: <span class="font-monospace">${c.VIN||'‚Äî'}</span></div>
          </div>
          <div class="text-end me-2">
            <div class="fw-bold">${fmtPrice(c.price)} ‚ÇΩ</div>
            ${statusBadge(c.status)}
          </div>
          <div class="d-flex gap-2">
            <a href="/cars/${encodeURIComponent(c.VIN||'')}/" class="btn btn-sm btn-outline-light">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</a>
            <button class="btn btn-sm btn-outline-danger fav-del">–£–±—Ä–∞—Ç—å</button>
          </div>
        </div>`;
    }).join('');
  }

  async function loadFav() {
    if (!TOKEN || !favList) return;
    try {
      const r = await fetch(`${API}/favorites/`, { headers: H_AUTH });
      if (!r.ok) throw new Error(r.statusText);
      const data = await r.json();
      const items = Array.isArray(data) ? data : (Array.isArray(data.results) ? data.results : []);
      await ensureCatalogLoadedForFav();
      renderFav(items);
    } catch (e) {
      console.error('favorites load error:', e);
      renderFav([]);
    }
  }

  favList?.addEventListener('click', async (e) => {
    const row = e.target.closest('.list-group-item'); if (!row) return;
    if (e.target.closest('.fav-del')) {
      const id = row.getAttribute('data-fav-id');
      if (!id) return;
      if (!confirm('–£–±—Ä–∞—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ?')) return;
      try {
        const r = await fetch(`${API}/favorites/${id}/`, { method:'DELETE', headers: H_AUTH });
        if (r.ok || r.status === 204) row.remove();
        if (!favList.children.length) renderFav([]);
      } catch (err) { alert(String(err)); }
    }
  });
  loadFav();
})();
</script>


{% endblock %}