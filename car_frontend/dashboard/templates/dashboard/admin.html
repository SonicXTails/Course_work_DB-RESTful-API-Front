{% extends "dashboard/base.html" %}
{% block title %}Админ{% endblock %}
{% load humanize %}

{% block content %}
<div class="container py-5 page-admin">

  <div class="d-flex align-items-center justify-content-between mb-4">
    <h2 class="mb-0">Админ-панель</h2>
    <span class="text-muted">Быстрые ссылки</span>
  </div>

  <div class="row g-3 mb-5">
    <div class="col-12 col-md-6 col-lg-4">
      <a id="btn-swagger" class="btn btn-tile btn-swagger w-100 py-3"
         href="http://127.0.0.1:8000/swagger/" target="_blank" rel="noopener">
        Swagger UI <small class="shortcut">(Alt+1)</small>
      </a>
    </div>
    <div class="col-12 col-md-6 col-lg-4">
      <a id="btn-redoc" class="btn btn-tile btn-redoc w-100 py-3"
         href="http://127.0.0.1:8000/redoc/" target="_blank" rel="noopener">
        ReDoc <small class="shortcut">(Alt+2)</small>
      </a>
    </div>
    <div class="col-12 col-md-6 col-lg-4">
      <a id="btn-admin8400" class="btn btn-tile btn-admin w-100 py-3"
         href="http://127.0.0.1:8400/admin/login/?next=/admin/" target="_blank" rel="noopener">
        Django Admin (порт 8400) <small class="shortcut">(Alt+3)</small>
      </a>
    </div>
    <div class="col-12 col-md-6 col-lg-4">
      <a id="btn-admin8000" class="btn btn-tile btn-admin w-100 py-3"
         href="http://127.0.0.1:8000/admin/login/?next=/admin/" target="_blank" rel="noopener">
        Django Admin (порт 8000) <small class="shortcut">(Alt+4)</small>
      </a>
    </div>
    <div class="col-12 col-md-6 col-lg-4">
      <a id="btn-api" class="btn btn-tile btn-drf w-100 py-3"
         href="http://127.0.0.1:8000/api/v1/" target="_blank" rel="noopener">
        DRF Browsable API <small class="shortcut">(Alt+5)</small>
      </a>
    </div>
  </div>

  <div class="d-flex align-items-end gap-3 mb-2">
    <div class="flex-grow-1">
      <label for="actorFilter" class="form-label mb-1">Фильтр по исполнителю</label>
      <select id="actorFilter" class="form-select">
        <option value="all">Все</option>
        <option value="admin">Только админ</option>
        <option value="users">Только пользователи</option>
        <option value="none">Никто</option>
      </select>
    </div>

    <div class="flex-grow-1">
      <label for="actorSearch" class="form-label mb-1">Поиск по логину</label>
      <input id="actorSearch" type="text" class="form-control" placeholder="Начни вводить логин…">
    </div>
  </div>

  <div class="d-flex align-items-center justify-content-between mt-3">
    <h3 class="mb-0">Последние действия</h3>
    <button id="auditToggleBtn" type="button"
            class="btn btn-outline-secondary btn-sm d-inline-flex align-items-center gap-1"
            aria-expanded="true">
      Скрыть логи <span class="text-body-secondary small">(Alt+V)</span>
    </button>
  </div>

  <div class="d-flex align-items-center justify-content-between mt-3">
    <p class="text-secondary small mb-2">
      Подсказка: нажми <kbd>Alt</kbd>+<kbd>V</kbd>, чтобы быстро скрыть или показать таблицу логов.
    </p>
  </div>

  <section id="auditSection" class="mt-3">
    <div class="table-responsive">
      <table class="table table-striped align-middle admin-table">
        <thead>
        <tr>
          <th>Когда</th>
          <th>Точная дата</th>
          <th>Пользователь</th>
          <th>Действие</th>
          <th>Таблица</th>
          <th>ID</th>
          <th>Изменения</th>
        </tr>
        </thead>
        <tbody id="auditBody">
        {% for log in audit_logs %}
          <tr>
            <td>{{ log.action_time|naturaltime }}</td>
            <td>{{ log.action_time|date:"d.m.Y H:i:s" }}</td>
            <td>
              {% if log.user_username %}
                {{ log.user_username }}
              {% elif log.user %}
                {{ log.user.username }}
              {% elif log.actor_label %}
                {{ log.actor_label }}
              {% else %}система{% endif %}
            </td>
            <td>
              {% if log.action == "CREATE" or log.action == "POST" %}
                <span class="badge bg-success">POST</span>
              {% elif log.action == "UPDATE" or log.action == "PUT" %}
                <span class="badge bg-warning text-dark">PUT</span>
              {% elif log.action == "DELETE" %}
                <span class="badge bg-danger">DELETE</span>
              {% else %}
                <span class="badge bg-secondary">{{ log.action }}</span>
              {% endif %}
            </td>
            <td>{{ log.table_name }}</td>
            <td>{{ log.record_id }}</td>
            <td>
              {% if log.action == "UPDATE" or log.action == "PUT" %}
                <details><summary>Посмотреть</summary>
                  <div><b>Старое:</b> {{ log.old_data }}</div>
                  <div><b>Новое:</b> {{ log.new_data }}</div>
                </details>
              {% elif log.action == "CREATE" or log.action == "POST" %}
                <span class="text-success">Создано</span>
              {% elif log.action == "DELETE" %}
                <span class="text-danger">Удалено</span>
              {% endif %}
            </td>
          </tr>
        {% empty %}
          <tr><td colspan="7" class="text-center text-body-secondary">Нет записей в аудит-логе</td></tr>
        {% endfor %}
        </tbody>
      </table>
      <div class="d-flex align-items-center justify-content-between mt-2" id="auditPager" hidden>
        <div class="small text-body-secondary" id="auditPageInfo">Страница 1</div>
        <div class="btn-group">
          <button id="auditPrev" type="button" class="btn btn-outline-secondary btn-sm" disabled>‹ Назад</button>
          <button id="auditNext" type="button" class="btn btn-outline-secondary btn-sm" disabled>Вперёд ›</button>
        </div>
      </div>
    </div>
  </section>

  <hr class="my-4">
  <h3 class="mb-3">Назначить роль пользователю</h3>

  <form id="roleForm" class="row g-3">
    <div class="col-md-5">
      <label for="userSearch" class="form-label">Пользователь</label>
      <input id="userSearch" type="text" class="form-control mb-2" placeholder="Начни вводить логин…" autocomplete="off">
      <select id="userSelect" class="form-select" size="8" required>
        {% for u in users %}
          <option value="{{ u.id }}">{{ u.username }}</option>
        {% endfor %}
        {% if not users %}
          <option disabled>Пользователей нет</option>
        {% endif %}
      </select>
      <div id="userEmptyHint" class="form-text d-none">Ничего не найдено</div>
    </div>

    <div class="col-md-5">
      <label for="roleSelect" class="form-label">Роль</label>
      <select id="roleSelect" class="form-select" required>
        <option value="">-- Выбери роль --</option>
        {% for r in roles %}
          <option value="{{ r.id }}">{{ r.name }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-2">
      <label class="form-label invisible">Действие</label>
      <button type="submit" class="btn btn-primary w-100">Назначить</button>
    </div>
  </form>

  <div id="roleResult" class="mt-3"></div>

  <hr class="my-4">
  <h3 class="mb-3 d-flex align-items-center justify-content-between">
    <span>Массовая пересценка бренда</span>
  </h3>

  <div class="row g-3 align-items-end">
    <div class="col-md-6">
      <label class="form-label">Бренд</label>
      <select id="repriceMake" class="form-select">
        <option value="">— выбери бренд —</option>
        {% if makes %}
          {% for m in makes %}
            <option value="{{ m.id }}">{{ m.name }}</option>
          {% endfor %}
        {% endif %}
      </select>
      <div class="form-text">Alt+R — фокус на поле процента</div>
    </div>

    <div class="col-md-3">
      <label class="form-label">Процент</label>
      <input id="repricePercent" type="number" step="0.01" class="form-control" placeholder="например, 5 или -3.5">
    </div>

    <div class="col-md-3">
      <button id="repriceBtn" class="btn btn-primary w-100">Пересчитать</button>
    </div>
  </div>

  <div id="repriceResult" class="mt-2"></div>

  <hr class="my-4">
  <h3 class="mb-3 d-flex align-items-center justify-content-between">
    <span>Резервные копии БД</span>
    <button id="backupsToggleBtn" type="button" class="btn btn-outline-secondary btn-sm">
      Скрыть бэкапы <small class="text-body-secondary">(Alt+K)</small>
    </button>
  </h3>

  <div class="d-flex flex-wrap align-items-center gap-2 mb-2">
    <button id="btnBackupNow" class="btn btn-success">
      Сделать бэкап <small class="text-dark-emphasis">(Alt+B)</small>
    </button>
    <button id="btnBackupsReload" class="btn btn-outline-secondary">
      Обновить список <small class="text-body-secondary">(Alt+L)</small>
    </button>
    <span class="text-body-secondary small ms-auto">
      Планировщик: ежедневно в <code>00:00</code> (локальная TZ проекта)
    </span>
  </div>

  <section id="backupsSection">
    <div class="table-responsive">
      <table class="table table-striped table-hover align-middle admin-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Когда</th>
            <th>Размер</th>
            <th>SHA-256</th>
            <th>Статус</th>
            <th class="text-end">Действия</th>
          </tr>
        </thead>
        <tbody id="backupsBody">
          <tr><td colspan="6" class="text-center text-body-secondary">Загружаю…</td></tr>
        </tbody>
      </table>
    </div>
  </section>

</div>

<style>
  .page-admin .btn-tile{border-width:2px;font-weight:600;border-color:var(--border);box-shadow:var(--shadow-sm,0 2px 8px rgba(0,0,0,.08))}
  .page-admin .btn-tile:hover{box-shadow:var(--shadow-md,0 10px 25px rgba(0,0,0,.1))}
  .btn-swagger{background:#85ea2d;color:#111}.btn-swagger .shortcut{color:#000;font-weight:500}
  .btn-redoc{background:#2d3e50;color:#fff}.btn-redoc .shortcut{color:#d1d5db}
  .btn-admin{background:#2c3e50;color:#f9f871}.btn-admin .shortcut{color:#b0bec5}
  .btn-drf{background:#6f42c1;color:#fff}.btn-drf .shortcut{color:#d1c4e9}
  .admin-table{--bs-table-bg:var(--bs-card-bg,var(--bg-elevated));--bs-table-color:var(--text);--bs-table-border-color:var(--border);--bs-table-striped-bg:color-mix(in srgb, var(--bs-table-bg) 92%, #000 8%);--bs-table-striped-color:var(--text)}
  [hidden]{display:none!important}
</style>

<script>
document.addEventListener("keydown", function(e){
  const tag=(e.target?.tagName||'').toLowerCase(); if(['input','textarea','select'].includes(tag)) return;
  if(!e.altKey) return;
  switch(e.key){
    case "1": document.getElementById("btn-swagger")?.click(); break;
    case "2": document.getElementById("btn-redoc")?.click(); break;
    case "3": document.getElementById("btn-admin8400")?.click(); break;
    case "4": document.getElementById("btn-admin8000")?.click(); break;
    case "5": document.getElementById("btn-api")?.click(); break;
    case "r": case "R": document.getElementById("repricePercent")?.focus(); break;
  }
});
</script>

<script>
  const API_BASE  = "http://127.0.0.1:8000/api/v1";
  const API_TOKEN = "{{ request.session.api_token|default:'' }}";
  async function apiFetch(path, options = {}){
    if(!API_TOKEN) throw new Error("Нет токена в сессии — перелогинься");
    const isAbs=/^https?:\/\//i.test(path);
    const url=isAbs?path:API_BASE+(path.startsWith("/")?path:("/"+path));
    const headers={"Authorization":"Token "+API_TOKEN,...(options.headers||{})};
    if(options.body && !headers["Content-Type"]) headers["Content-Type"]="application/json";
    return fetch(url,{...options,headers,mode:"cors",credentials:"omit"});
  }
</script>

<script>
(function(){
  const searchInput = document.getElementById('userSearch');
  const selectEl    = document.getElementById('userSelect');
  const emptyHint   = document.getElementById('userEmptyHint');
  if (!searchInput || !selectEl) return;

  const collect = () =>
    Array.from(selectEl.options).map(o => ({ value: o.value, text: o.text })).filter(o => !!o.value);

  let allOptions = collect();

  function render(list, prefer = null){
    const prev = prefer ?? (selectEl.value || null);
    selectEl.innerHTML = '';
    for (const {value, text} of list){
      const opt = document.createElement('option');
      opt.value = value; opt.textContent = text; selectEl.appendChild(opt);
    }
    if (list.length > 0){
      const idx = list.findIndex(x => x.value == prev);
      selectEl.selectedIndex = idx >= 0 ? idx : 0;
      emptyHint.classList.add('d-none');
    } else {
      emptyHint.classList.remove('d-none');
    }
  }
  function filterUsers(q){
    const query = q.trim().toLowerCase();
    const filtered = query ? allOptions.filter(o => o.text.toLowerCase().includes(query)) : allOptions;
    render(filtered);
  }

  let t;
  searchInput.addEventListener('input', ()=>{
    clearTimeout(t); t = setTimeout(()=>filterUsers(searchInput.value), 100);
  });
  searchInput.addEventListener('keydown', (e)=>{
    if (e.key === 'ArrowDown'){ e.preventDefault(); selectEl.focus(); }
  });
  selectEl.addEventListener('dblclick', ()=>{
    document.querySelector('#roleForm button[type="submit"]')?.click();
  });

  document.addEventListener('users-loaded', ()=>{
    allOptions = collect();
    render(allOptions);
  });

  render(allOptions);
})();
</script>

<script>
(function(){
  const form = document.getElementById("roleForm");
  if (!form) return;

  const userSel   = document.getElementById("userSelect");
  const roleSel   = document.getElementById("roleSelect");
  const resultDiv = document.getElementById("roleResult");
  const submitBtn = form.querySelector('button[type="submit"]');

  async function tryAssignJSON(userId, roleId){
    return apiFetch("/admin/user_roles/assign/", {
      method: "POST",
      body: JSON.stringify({ user: userId, role: roleId })
    });
  }
  async function tryAssignForm(userId, roleId){
    const body = new URLSearchParams({ user: String(userId), role: String(roleId) });
    return apiFetch("/admin/user_roles/assign/", {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body
    });
  }
  async function parseMaybeJSON(res){
    const txt = await res.text();
    try { return txt ? JSON.parse(txt) : null; } catch { return txt || null; }
  }
  function show(ok, html){
    resultDiv.innerHTML = `<div class="alert alert-${ok?'success':'danger'}">${html}</div>`;
  }

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const userId = Number(userSel.value);
    const roleId = Number(roleSel.value);
    if (!userId || !roleId) {
      show(false, "Выбери пользователя и роль");
      return;
    }

    const old = submitBtn.textContent;
    submitBtn.disabled = true; submitBtn.textContent = "Назначаю…";

    try {
      let res = await tryAssignJSON(userId, roleId);
      if (res.status === 415) res = await tryAssignForm(userId, roleId);

      const data = await parseMaybeJSON(res);
      if (res.ok) {
        const u = (data && (data.user ?? data.user_id)) ?? userId;
        const r = (data && (data.role ?? data.role_id)) ?? roleId;
        show(true, `Роль назначена: user=${u}, role=${r}`);

        // мгновенно перезагрузить аудит-лог
        document.dispatchEvent(new CustomEvent("auditlog-reload"));
      } else {
        const msg = (data && (data.detail || data.error || JSON.stringify(data))) || `HTTP ${res.status}`;
        show(false, `Не удалось назначить роль. ${msg}`);
      }
    } catch (err) {
      const hint = String(err).includes("перелогинься")
        ? "Сессия без токена — зайди заново через форму авторизации."
        : "Проверь заголовок Authorization и CORS.";
      show(false, `Ошибка: ${String(err)}<br>${hint}`);
    } finally {
      submitBtn.disabled = false; submitBtn.textContent = old;
    }
  });
})();
</script>

<script>
(async function(){
  const userSel = document.getElementById("userSelect");
  const roleSel = document.getElementById("roleSelect");
  if (!userSel || !roleSel) return;

  async function getJSON(url){
    const res = await apiFetch(url);
    if (!res.ok) throw new Error(res.status);
    try { return await res.json(); } catch { return null; }
  }
  function unwrap(listish){
    if (!listish) return [];
    if (Array.isArray(listish)) return listish;
    if (Array.isArray(listish.results)) return listish.results;
    if (Array.isArray(listish.items))   return listish.items;
    if (listish.data) return unwrap(listish.data);
    return [];
  }
  function userLabel(u){
    return u.username ?? u.login ?? u.email ?? u.name ?? u.user?.username ?? `user#${u.id ?? u.pk ?? u.user_id ?? ''}`;
  }
  function userId(u){
    return u.id ?? u.pk ?? u.user_id ?? u.user?.id;
  }

  let users = [];
  for (const ep of ["/admin/users/?limit=1000", "/users/?limit=1000", "/auth/users/?limit=1000"]) {
    try {
      users = unwrap(await getJSON(ep));
      if (users.length) break;
    } catch (_) {}
  }
  if (users.length) {
    userSel.innerHTML = users.map(u => {
      const id = userId(u); if (!id) return "";
      return `<option value="${id}">${userLabel(u)}</option>`;
    }).join("");
    document.dispatchEvent(new CustomEvent("users-loaded"));
  } else {
    userSel.innerHTML = `<option disabled>Пользователей нет</option>`;
  }

  try {
    const rolesRaw = await getJSON("/admin/roles/?limit=1000");
    const roles = unwrap(rolesRaw);
    if (roles.length) {
      roleSel.innerHTML = ['<option value="">-- Выбери роль --</option>']
        .concat(roles.map(r => `<option value="${r.id}">${r.name ?? ('role#'+r.id)}</option>`))
        .join('');
    }
  } catch (_) {}
})();
</script>

<!-- Пагинация аудит-логов -->
<script>
(function(){
  let isLoading = false;
  const section   = document.getElementById('auditSection');
  const tbody     = document.getElementById('auditBody');
  const pager     = document.getElementById('auditPager');
  const pageInfo  = document.getElementById('auditPageInfo');
  const prevBtn   = document.getElementById('auditPrev');
  const nextBtn   = document.getElementById('auditNext');
  const filterEl  = document.getElementById('actorFilter');
  const searchEl  = document.getElementById('actorSearch');
  const toggleBtn = document.getElementById('auditToggleBtn');
  if(!section||!tbody||!pager) return;

  const PAGE_SIZE=30;
  let page=Math.max(1,Number(localStorage.getItem('audit_page')||'1'));
  let total=null, dataPage=[], allCache=null, useClientSlice=false;

  const pad=n=>String(n).padStart(2,'0');
  const fmtDate=iso=>{const d=new Date(iso); return `${pad(d.getDate())}.${pad(d.getMonth()+1)}.${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;};
  const ago=iso=>{const s=Math.max(1,Math.floor((Date.now()-new Date(iso).getTime())/1000)); if(s<60)return `${s} с назад`; const m=Math.floor(s/60); if(m<60)return `${m} мин назад`; const h=Math.floor(m/60); if(h<24)return `${h} ч назад`; const d=Math.floor(h/24); return `${d} д назад`;};
  const badge=a=>a==='CREATE'||a==='POST'?'<span class="badge bg-success">POST</span>':a==='UPDATE'||a==='PUT'?'<span class="badge bg-warning text-dark">PUT</span>':a==='DELETE'?'<span class="badge bg-danger">DELETE</span>':`<span class="badge bg-secondary">${a}</span>`;

  const actorName = l =>
    l.actor_label || l.user_username || l.user?.username || l.actor || l.username || 'система';

  const hasUser = l => !!(l.user_username || l.user?.username || Number.isFinite(l.user) || l.user_id);
  const isAdmin = l => String(l.actor_label || l.actor || '').toLowerCase().startsWith('admin');
  const isNone  = l => !hasUser(l) && !isAdmin(l);

  document.addEventListener('auditlog-reload', () => { page = 1; load(); });

  function applyFilter(list){
    const q=(searchEl?.value||'').trim().toLowerCase();
    const mode=filterEl?.value||'all';
    const passMode = l =>
      mode==='admin' ? isAdmin(l) :
      mode==='users' ? (hasUser(l) && !isAdmin(l)) :
      mode==='none'  ? isNone(l) :
      true;
    return list.filter(passMode).filter(l => !q || actorName(l).toLowerCase().includes(q));
  }

  function render(){
    const list=applyFilter(dataPage);
    tbody.innerHTML=list.length?list.map(l=>`
      <tr>
        <td>${ago(l.action_time)}</td>
        <td>${fmtDate(l.action_time)}</td>
        <td>${actorName(l)}</td>
        <td>${badge(l.action)}</td>
        <td>${l.table_name??''}</td>
        <td>${l.record_id??''}</td>
        <td>${
          (l.action==='UPDATE'||l.action==='PUT')
            ? `<details><summary>Посмотреть</summary>
                 <div><b>Старое:</b> ${typeof l.old_data==='object'?JSON.stringify(l.old_data):(l.old_data??'')}</div>
                 <div><b>Новое:</b> ${typeof l.new_data==='object'?JSON.stringify(l.new_data):(l.new_data??'')}</div>
               </details>`
            : (l.action==='CREATE'||l.action==='POST')?'<span class="text-success">Создано</span>'
            : (l.action==='DELETE')?'<span class="text-danger">Удалено</span>' : ''
        }</td>
      </tr>`).join(''):`<tr><td colspan="7" class="text-center text-body-secondary">Нет записей</td></tr>`;

    pager.hidden=false;
    const start=list.length?((page-1)*PAGE_SIZE+1):0;
    const end=(page-1)*PAGE_SIZE+list.length;
    const pages=Number.isFinite(total)?Math.max(1,Math.ceil(total/PAGE_SIZE)):null;

    pageInfo.textContent=Number.isFinite(total)?`Показано ${start}–${end} из ${total} | Стр. ${page}${pages?` из ${pages}`:''}`:`Стр. ${page} (по ${PAGE_SIZE})`;
    if(useClientSlice && Number.isFinite(total)){ prevBtn.disabled=page<=1; nextBtn.disabled=page>=pages; }
    else { prevBtn.disabled=page<=1; nextBtn.disabled=dataPage.length<PAGE_SIZE || (Number.isFinite(total)&&end>=total); }
  }

  async function fetchServerPage(offset){
    const res=await apiFetch(`/admin/audit_logs/?limit=${PAGE_SIZE}&offset=${offset}&ordering=-action_time`);
    if(!res.ok) throw new Error('HTTP '+res.status);
    return res.json();
  }

  async function load(){
    if (isLoading) return;
    isLoading = true;

    const offset=(page-1)*PAGE_SIZE;
    try{
      if(useClientSlice && Array.isArray(allCache)){
        dataPage = allCache.slice(offset, offset+PAGE_SIZE);
        render();
      } else {
        const json = await fetchServerPage(offset);
        if (Array.isArray(json)){
          allCache = json;
          total = json.length;
          useClientSlice = true;
          dataPage = json.slice(offset, offset+PAGE_SIZE);
        } else {
          const results = Array.isArray(json.results) ? json.results : [];
          total = Number.isFinite(json.count) ? json.count : null;
          useClientSlice = false;
          dataPage = results;
        }
        render();
      }
    } catch(e){
      console.error('auditlog load error:', e);
    } finally {
      isLoading = false;
    }
  }

  // автообновление каждые 5 секунд при видимой вкладке и секции
  setInterval(() => {
    if (document.hidden || section.hidden) return;
    load();
  }, 5000);

  prevBtn?.addEventListener('click',()=>{ if(page>1){ page--; localStorage.setItem('audit_page',String(page)); load(); }});
  nextBtn?.addEventListener('click',()=>{
    const pages=Number.isFinite(total)?Math.max(1,Math.ceil(total/PAGE_SIZE)):null;
    const canNext=useClientSlice?(pages?page<pages:dataPage.length===PAGE_SIZE)
                                :(dataPage.length===PAGE_SIZE || (Number.isFinite(total)&& (page-1)*PAGE_SIZE+dataPage.length<total));
    if(canNext){ page++; localStorage.setItem('audit_page',String(page)); load(); }
  });

  filterEl?.addEventListener('change', render);
  let t; searchEl?.addEventListener('input', ()=>{ clearTimeout(t); t=setTimeout(render,150); });

  function setHidden(hidden){
    section.hidden=!!hidden;
    toggleBtn?.setAttribute('aria-expanded',hidden?'false':'true');
    toggleBtn&&(toggleBtn.innerHTML=(hidden?'Показать':'Скрыть')+' логи <span class="text-body-secondary small">(Alt+V)</span>');
    localStorage.setItem('audit_logs_hidden', hidden?'1':'0');
  }
  setHidden(localStorage.getItem('audit_logs_hidden')==='1');
  toggleBtn?.addEventListener('click',()=>setHidden(!section.hidden));
  document.addEventListener('keydown',(e)=>{
    const tag=(document.activeElement?.tagName||'').toLowerCase();
    if(['input','textarea','select'].includes(tag) || document.activeElement?.isContentEditable) return;
    if(e.altKey && !e.ctrlKey && e.code==='KeyV'){ e.preventDefault(); toggleBtn?.click(); }
  });

  load();
})();
</script>

<!-- Бэкапы -->
<script>
(function(){
  const API={
    list:    () => apiFetch("/backups/"),
    create:  () => apiFetch("/backups/",{method:"POST"}),
    detail:  (id) => apiFetch(`/backups/${id}/`),
    delete:  (id) => apiFetch(`/backups/${id}/`, {method:"DELETE"}),
    download:(id) => apiFetch(`/backups/${id}/download/`)
  };
  const $=sel=>document.querySelector(sel);
  const body=$("#backupsBody"), btnNow=$("#btnBackupNow"), btnReload=$("#btnBackupsReload"), section=$("#backupsSection"), toggleBtn=$("#backupsToggleBtn");

  const pad=n=>String(n).padStart(2,"0");
  const fmtWhen=iso=>{ try{const d=new Date(iso); return `${pad(d.getDate())}.${pad(d.getMonth()+1)}.${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;}catch{ return iso||"—";}};
  const fmtSize=n=>{const b=Number(n||0); if(b>=1073741824) return (b/1073741824).toFixed(2)+" ГБ"; if(b>=1048576) return (b/1048576).toFixed(2)+" МБ"; if(b>=1024) return (b/1024).toFixed(1)+" КБ"; return b+" Б";};

  async function loadBackups(){
    body.innerHTML=`<tr><td colspan="6" class="text-center text-body-secondary">Загружаю…</td></tr>`;
    try{
      const res=await API.list(); const data=await res.json();
      const items=Array.isArray(data)?data:(Array.isArray(data.results)?data.results:[]);
      if(!items.length){ body.innerHTML=`<tr><td colspan="6" class="text-center text-body-secondary">Бэкапов пока нет</td></tr>`; return; }
      body.innerHTML=items.map(it=>{
        const id=it.id;
        const sha=(it.checksum_sha256||"").slice(0,12);
        const st=String(it.status||"").toLowerCase();
        const badge=st==="success"?"success":(st==="pending"?"secondary":"danger");
        const fn=`backup_${id||""}.sql.gz`;
        const dlDisabled=st!=="success"?"disabled":"";
        return `<tr>
          <td>${id}</td>
          <td>${fmtWhen(it.created_at)}</td>
          <td>${fmtSize(it.file_size)}</td>
          <td><code title="${it.checksum_sha256||''}">${sha||"—"}</code></td>
          <td><span class="badge bg-${badge}">${st||"—"}</span></td>
          <td class="text-end">
            <div class="btn-group btn-group-sm">
              <button class="btn btn-outline-primary" data-dl="${id}" data-fn="${fn}" ${dlDisabled}>Скачать</button>
              <button class="btn btn-outline-danger" data-del="${id}">Удалить</button>
            </div>
          </td>
        </tr>`;
      }).join("");
    }catch{ body.innerHTML=`<tr><td colspan="6" class="text-center text-danger">Ошибка загрузки списка</td></tr>`; }
  }

  async function downloadBackup(id,filename){
    const res=await API.download(id);
    if(!res.ok) throw new Error("HTTP "+res.status);
    const blob=await res.blob();
    const a=document.createElement("a");
    a.href=URL.createObjectURL(blob);
    a.download=filename||("backup_"+id+".sql.gz");
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(a.href),5000);
  }

  async function deleteBackup(id){
    if(!confirm(`Удалить бэкап #${id}? Это действие необратимо.`)) return;
    const delBtn = body.querySelector(`button[data-del="${id}"]`);
    const oldTxt = delBtn?.textContent;
    try{
      if(delBtn){ delBtn.disabled = true; delBtn.textContent = "Удаляю…"; }
      const res=await API.delete(id);
      if(!res.ok) throw new Error("HTTP "+res.status);
      await loadBackups();
    }catch(e){
      alert("Не удалось удалить бэкап: "+String(e));
    }finally{
      if(delBtn){ delBtn.disabled=false; delBtn.textContent = oldTxt || "Удалить"; }
    }
  }

  // Ожидание готовности бэкапа (poll)
  async function pollUntilReady(id, {interval=2000, timeout=60000} = {}){
    const start = Date.now();
    while (Date.now() - start < timeout){
      const res = await API.detail(id);
      if(!res.ok) throw new Error("HTTP "+res.status);
      const data = await res.json().catch(()=>({}));
      const st = String(data.status||"").toLowerCase();
      if(st === "success") return data;
      if(st === "failed" || st === "error") throw new Error(data.error || "Бэкап завершился с ошибкой");
      await new Promise(r=>setTimeout(r, interval));
    }
    throw new Error("Таймаут ожидания готовности бэкапа");
  }

  async function createBackup(){
    btnNow.disabled=true; const old=btnNow.textContent; btnNow.textContent="Делаю бэкап…";
    try{
      const res=await API.create();
      const data=await res.json().catch(()=>({}));
      if(!res.ok){
        const msg=data.detail||data.log||JSON.stringify(data)||("HTTP "+res.status);
        throw new Error(msg);
      }

      const id = data.id ?? data.pk ?? data.backup_id;
      let st = String(data.status||"").toLowerCase();

      // Если бэкап ещё в обработке — ждём готовности
      if(st !== "success"){
        await pollUntilReady(id, {interval:2000, timeout:120000});
      }

      // Обновим список и автоматически скачаем свежий бэкап
      await loadBackups();
      try{
        await downloadBackup(id, `backup_${id}.sql.gz`);
      }catch(dlErr){
        console.warn("Не удалось автоматически скачать бэкап:", dlErr);
        alert("Бэкап готов, но скачать автоматически не вышло. Скачай вручную из списка.");
      }
    }catch(e){
      alert("Не удалось сделать бэкап: "+String(e));
    }finally{
      btnNow.disabled=false; btnNow.textContent=old;
    }
  }

  const LS_KEY="backups_table_hidden";
  function setHidden(hidden){
    section.hidden=!!hidden;
    toggleBtn.textContent=hidden?"Показать бэкапы":"Скрыть бэкапы";
    toggleBtn.insertAdjacentHTML("beforeend",' <small class="text-body-secondary">(Alt+K)</small>');
    localStorage.setItem(LS_KEY, hidden?"1":"0");
  }
  setHidden(localStorage.getItem(LS_KEY)==="1");
  toggleBtn?.addEventListener("click",()=>setHidden(!section.hidden));
  document.addEventListener("keydown",(e)=>{
    const tag=(document.activeElement?.tagName||"").toLowerCase();
    if(['input','textarea','select'].includes(tag) || document.activeElement?.isContentEditable) return;
    if(e.altKey && !e.ctrlKey && !e.shiftKey && e.code==="KeyK"){ e.preventDefault(); toggleBtn?.click(); }
  });

  body.addEventListener("click",(e)=>{
    const dl=e.target.closest("button[data-dl]");
    if(dl){ downloadBackup(dl.getAttribute("data-dl"), dl.getAttribute("data-fn")).catch(err=>alert("Не удалось скачать: "+String(err))); return; }
    const del=e.target.closest("button[data-del]");
    if(del){ deleteBackup(del.getAttribute("data-del")); return; }
  });

  btnNow?.addEventListener("click",createBackup);
  btnReload?.addEventListener("click",loadBackups);
  loadBackups();
})();
</script>

{% endblock %}