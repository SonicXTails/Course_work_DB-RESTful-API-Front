{% extends "dashboard/base.html" %}
{% block title %}Админ{% endblock %}
{% load humanize %}

{% block content %}
<div class="container py-5">
  <div class="d-flex align-items-center justify-content-between mb-4">
    <h2 class="mb-0">Админ-панель</h2>
    <span class="text-muted">Быстрые ссылки</span>
  </div>

  <div class="row g-3 mb-5">
    <div class="col-12 col-md-6 col-lg-4">
      <a id="btn-swagger" class="btn btn-swagger w-100 py-3"
         href="http://127.0.0.1:8000/swagger/" target="_blank" rel="noopener">
        Swagger UI <small class="shortcut">(Alt+1)</small>
      </a>
    </div>
    <div class="col-12 col-md-6 col-lg-4">
      <a id="btn-redoc" class="btn btn-redoc w-100 py-3"
         href="http://127.0.0.1:8000/redoc/" target="_blank" rel="noopener">
        ReDoc <small class="shortcut">(Alt+2)</small>
      </a>
    </div>
    <div class="col-12 col-md-6 col-lg-4">
      <a id="btn-admin8400" class="btn btn-admin w-100 py-3"
         href="http://127.0.0.1:8400/admin/login/?next=/admin/" target="_blank" rel="noopener">
        Django Admin (порт 8400) <small class="shortcut">(Alt+3)</small>
      </a>
    </div>
    <div class="col-12 col-md-6 col-lg-4">
      <a id="btn-admin8000" class="btn btn-admin w-100 py-3"
         href="http://127.0.0.1:8000/admin/login/?next=/admin/" target="_blank" rel="noopener">
        Django Admin (порт 8000) <small class="shortcut">(Alt+4)</small>
      </a>
    </div>
    <div class="col-12 col-md-6 col-lg-4">
      <a id="btn-api" class="btn btn-drf w-100 py-3"
         href="http://127.0.0.1:8000/api/v1/" target="_blank" rel="noopener">
        DRF Browsable API <small class="shortcut">(Alt+5)</small>
      </a>
    </div>
  </div>

  <div class="d-flex align-items-end gap-3 mb-2">
  <div class="flex-grow-1">
    <label for="actorFilter" class="form-label mb-1">Фильтр по исполнителю</label>
    <select id="actorFilter" class="form-select">
      <option value="all">Все</option>
      <option value="admin">Только админ</option>
      <option value="users">Только пользователи</option>
      <option value="none">Никто</option>  <!-- NEW -->
    </select>
  </div>

    <div class="flex-grow-1">
    <label for="actorSearch" class="form-label mb-1">Поиск по логину</label>
    <input id="actorSearch" type="text" class="form-control" placeholder="Начни вводить логин…">
  </div>
</div>


<style>
#auditToggleBtn {
  background-color: #212529; /* тот же, что у table-dark */
  border-color: #343a40;
  color: #f8f9fa;
}
#auditToggleBtn:hover {
  background-color: #343a40;
  border-color: #212529;
}
</style>

<div class="d-flex align-items-center justify-content-between mt-3">
  <h3 class="mb-0">Последние действия</h3>
  <button id="auditToggleBtn"
          type="button"
          class="btn btn-dark btn-sm d-inline-flex align-items-center gap-1"
          aria-expanded="true">
    Скрыть логи <span class="text-light-emphasis small">(Alt+V)</span>
  </button>
</div>

<div class="d-flex align-items-center justify-content-between mt-3">
  <p class="text-muted small mb-2">
    Подсказка: нажми <kbd>Alt</kbd>+<kbd>V</kbd> , чтобы быстро скрыть или показать таблицу логов.
  </p>
</div>

<style>
  [hidden] { display: none !important; }
</style>

<section id="auditSection" class="mt-3">
  <div class="table-responsive">
    <table class="table table-dark table-striped align-middle">
      <thead>
      <tr>
        <th>Когда</th>
        <th>Точная дата</th>
        <th>Пользователь</th>
        <th>Действие</th>
        <th>Таблица</th>
        <th>ID</th>
        <th>Изменения</th>
      </tr>
      </thead>
      <tbody id="auditBody">
      {% for log in audit_logs %}
        <tr>
          <td>{{ log.action_time|naturaltime }}</td>
          <td>{{ log.action_time|date:"d.m.Y H:i:s" }}</td>
          <td>
            {% if log.user_username %}
              {{ log.user_username }}
            {% elif log.user %}
              {{ log.user.username }}
            {% elif log.actor_label %}
              {{ log.actor_label }}
            {% else %}
              незнакомец
            {% endif %}
          </td>
          <td>
            {% if log.action == "CREATE" or log.action == "POST" %}
              <span class="badge bg-success">POST</span>
            {% elif log.action == "UPDATE" or log.action == "PUT" %}
              <span class="badge bg-warning text-dark">PUT</span>
            {% elif log.action == "DELETE" %}
              <span class="badge bg-danger">DELETE</span>
            {% else %}
              <span class="badge bg-secondary">{{ log.action }}</span>
            {% endif %}
          </td>
          <td>{{ log.table_name }}</td>
          <td>{{ log.record_id }}</td>
          <td>
            {% if log.action == "UPDATE" or log.action == "PUT" %}
              <details><summary>Посмотреть</summary>
                <div><b>Старое:</b> {{ log.old_data }}</div>
                <div><b>Новое:</b> {{ log.new_data }}</div>
              </details>
            {% elif log.action == "CREATE" or log.action == "POST" %}
              <span class="text-success">Создано</span>
            {% elif log.action == "DELETE" %}
              <span class="text-danger">Удалено</span>
            {% endif %}
          </td>
        </tr>
      {% empty %}
        <tr><td colspan="7" class="text-center text-muted">Нет записей в аудит-логе</td></tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
</section>

  <hr class="my-4">
  <h3 class="mb-3">Назначить роль пользователю</h3>

  <form id="roleForm" class="row g-3">
    <div class="col-md-5">
      <label for="userSearch" class="form-label">Пользователь</label>
      <input id="userSearch" type="text" class="form-control mb-2" placeholder="Начни вводить логин…" autocomplete="off">
      <select id="userSelect" class="form-select" size="8" required>
        {% for u in users %}
          <option value="{{ u.id }}">{{ u.username }}</option>
        {% endfor %}
        {% if not users %}
          <option disabled>Пользователей нет</option>
        {% endif %}
      </select>
      <div id="userEmptyHint" class="form-text d-none">Ничего не найдено</div>
    </div>

    <div class="col-md-5">
      <label for="roleSelect" class="form-label">Роль</label>
      <select id="roleSelect" class="form-select" required>
        <option value="">-- Выбери роль --</option>
        {% for r in roles %}
          <option value="{{ r.id }}">{{ r.name }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-2">
      <label class="form-label invisible">Действие</label>
      <button type="submit" class="btn btn-primary w-100">Назначить</button>
    </div>
  </form>

  <div id="roleResult" class="mt-3"></div>
</div>

<style>
.btn-swagger:hover { background:#6ec11f;color:#fff; border-color:#000; }
.btn-redoc:hover { background:#1f2a36; color:#fff; border-color:#1a252f; }

.btn-swagger { background:#85ea2d; color:#fff; border:2px solid #000; font-weight:600; }
.btn-swagger .shortcut { color:#000; font-weight:normal; }

.btn-redoc { background:#2d3e50; color:#fff; border:2px solid #1f2a36; font-weight:600; }
.btn-redoc .shortcut { color:#e0e0e0; font-weight:normal; }

.btn-admin { background:#2c3e50; color:#f9f871; border:2px solid #1a252f; font-weight:600; }
.btn-admin:hover { background:#1f2a36; color:#fff9c4; }
.btn-admin .shortcut { color:#b0bec5; font-weight:normal; }

.btn-drf { background:#6f42c1; color:#fff; border:2px solid #563d7c; font-weight:600; }
.btn-drf:hover { background:#563d7c; }
.btn-drf .shortcut { color:#d1c4e9; font-weight:normal; }
</style>

<script>
document.addEventListener("keydown", function(e) {
  const tag = (e.target?.tagName || '').toLowerCase();
  if (tag === 'input' || tag === 'textarea' || tag === 'select') return;
  if (!e.altKey) return;
  switch (e.key) {
    case "1": document.getElementById("btn-swagger").click(); break;
    case "2": document.getElementById("btn-redoc").click(); break;
    case "3": document.getElementById("btn-admin8400").click(); break;
    case "4": document.getElementById("btn-admin8000").click(); break;
    case "5": document.getElementById("btn-api").click(); break;
  }
});
</script>

<script>
(function () {
  const searchInput = document.getElementById('userSearch');
  const selectEl    = document.getElementById('userSelect');
  const emptyHint   = document.getElementById('userEmptyHint');
  if (!searchInput || !selectEl) return;

  const allOptions = Array.from(selectEl.options).map(o => ({
    value: o.value, text: o.text
  })).filter(o => !!o.value);

  function render(list, prefer = null) {
    const prev = prefer ?? (selectEl.value || null);
    selectEl.innerHTML = '';
    for (const {value, text} of list) {
      const opt = document.createElement('option');
      opt.value = value; opt.textContent = text;
      selectEl.appendChild(opt);
    }
    if (list.length > 0) {
      const idx = list.findIndex(x => x.value == prev);
      selectEl.selectedIndex = idx >= 0 ? idx : 0;
      emptyHint.classList.add('d-none');
    } else {
      emptyHint.classList.remove('d-none');
    }
  }

  function filterUsers(q) {
    const query = q.trim().toLowerCase();
    const filtered = query ? allOptions.filter(o => o.text.toLowerCase().includes(query)) : allOptions;
    render(filtered);
  }

  let t;
  searchInput.addEventListener('input', () => {
    clearTimeout(t);
    t = setTimeout(() => filterUsers(searchInput.value), 100);
  });

  searchInput.addEventListener('keydown', (e) => {
    if (e.key === 'ArrowDown') { e.preventDefault(); selectEl.focus(); }
  });

  selectEl.addEventListener('dblclick', () => {
    document.querySelector('#roleForm button[type="submit"]')?.click();
  });

  render(allOptions);
})();
</script>

<script>
const API_BASE  = "http://127.0.0.1:8000/api/v1";
const API_TOKEN = "{{ request.session.api_token|default:'' }}";

async function apiFetch(path, options = {}) {
  if (!API_TOKEN) throw new Error("Нет токена в сессии — перелогинься");
  const headers = { "Authorization": "Token " + API_TOKEN, ...(options.headers || {}) };
  if (options.body && !headers["Content-Type"]) headers["Content-Type"] = "application/json";
  return fetch(API_BASE + path, { ...options, headers, mode: "cors" });
}

(function () {
  const form      = document.getElementById("roleForm");
  const userSel   = document.getElementById("userSelect");
  const roleSel   = document.getElementById("roleSelect");
  const resultDiv = document.getElementById("roleResult");
  const submitBtn = form?.querySelector('button[type="submit"]');
  if (!form) return;

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const userId = Number(userSel.value);
    const roleId = Number(roleSel.value);
    if (!userId || !roleId) {
      resultDiv.innerHTML = `<div class="alert alert-warning">Выбери пользователя и роль</div>`;
      return;
    }
    try {
      submitBtn.disabled = true;
      const oldText = submitBtn.textContent;
      submitBtn.textContent = "Назначаю…";

      const res = await apiFetch("/admin/user_roles/assign/", {
        method: "PUT",
        body: JSON.stringify({ user: userId, role: roleId })
      });

      let data = null; try { data = await res.json(); } catch(_) {}

      if (res.ok && data && (data.id || (data.user && data.role))) {
        resultDiv.innerHTML = `<div class="alert alert-success">Роль назначена: user=${data.user}, role=${data.role}</div>`;
      } else {
        resultDiv.innerHTML = `<div class="alert alert-danger">Не удалось назначить роль. Код: ${res.status}<br>${data ? JSON.stringify(data) : "Пустой ответ"}</div>`;
      }
      submitBtn.textContent = oldText;
      submitBtn.disabled = false;
    } catch (err) {
      const hint = String(err).includes("перелогинься")
        ? "Сессия без токена — зайди заново через форму авторизации."
        : "Проверь, что в запросе есть заголовок Authorization и настроен CORS.";
      resultDiv.innerHTML = `<div class="alert alert-danger">Ошибка: ${String(err)}<br>${hint}</div>`;
      submitBtn.disabled = false;
    }
  });
})();
</script>

<script>
(function () {
  const API_BASE  = "http://127.0.0.1:8000/api/v1";
  const API_TOKEN = "{{ request.session.api_token|default:'' }}";

  async function apiFetch(path, options = {}) {
    if (!API_TOKEN) throw new Error("Нет токена в сессии — перелогинься");
    const headers = { "Authorization": "Token " + API_TOKEN, ...(options.headers || {}) };
    if (options.body && !headers["Content-Type"]) headers["Content-Type"] = "application/json";
    return fetch(API_BASE + path, { ...options, headers, mode: "cors" });
  }

  const section  = document.getElementById('auditSection');
  const tbody    = document.getElementById('auditBody');
  const btn      = document.getElementById('auditToggleBtn');
  const filterEl = document.getElementById('actorFilter');
  const searchEl = document.getElementById('actorSearch');

  if (!section || !tbody || !btn) return;

  btn.disabled = false;
  btn.removeAttribute('disabled');
  btn.style.pointerEvents = 'auto';

  let rawData = [];
  let lastHash = null;
  const intervalMs = 5000;

  const pad = n => String(n).padStart(2, '0');
  const fmtDate = iso => {
    const d = new Date(iso);
    return `${pad(d.getDate())}.${pad(d.getMonth()+1)}.${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
  };
  const ago = iso => {
    const sec = Math.max(1, Math.floor((Date.now() - new Date(iso).getTime())/1000));
    if (sec < 60) return `${sec} с назад`;
    const min = Math.floor(sec/60);
    if (min < 60) return `${min} мин назад`;
    const hr = Math.floor(min/60);
    if (hr < 24) return `${hr} ч назад`;
    const day = Math.floor(hr/24);
    return `${day} д назад`;
  };
  const badge = a => a==='CREATE'||a==='POST' ? '<span class="badge bg-success">POST</span>'
                : a==='UPDATE'||a==='PUT' ? '<span class="badge bg-warning text-dark">PUT</span>'
                : a==='DELETE' ? '<span class="badge bg-danger">DELETE</span>'
                : `<span class="badge bg-secondary">${a}</span>`;

  const actorName = log => log.actor_label || log.user_username || 'незнакомец';

  const rowHtml = log => {
    const whenHuman = ago(log.action_time);
    const whenExact = fmtDate(log.action_time);
    const actor = actorName(log);
    let changes = '';
    if (log.action === 'UPDATE' || log.action === 'PUT') {
      const od = typeof log.old_data === 'object' ? JSON.stringify(log.old_data) : (log.old_data ?? '');
      const nd = typeof log.new_data === 'object' ? JSON.stringify(log.new_data) : (log.new_data ?? '');
      changes = `<details data-log-id="${log.id||''}"><summary>Посмотреть</summary><div><b>Старое:</b> ${od}</div><div><b>Новое:</b> ${nd}</div></details>`;
    } else if (log.action === 'CREATE' || log.action === 'POST') {
      changes = `<span class="text-success">Создано</span>`;
    } else if (log.action === 'DELETE') {
      changes = `<span class="text-danger">Удалено</span>`;
    }
    return `<tr data-log-id="${log.id||''}">
      <td>${whenHuman}</td>
      <td>${whenExact}</td>
      <td>${actor}</td>
      <td>${badge(log.action)}</td>
      <td>${log.table_name ?? ''}</td>
      <td>${log.record_id ?? ''}</td>
      <td>${changes}</td>
    </tr>`;
  };

  const isAdminLog = log => (log.actor_label || '').toLowerCase().startsWith('admin:');
  const isUserLog  = log => (log.user != null) && !isAdminLog(log);

  const isNoneLog  = log =>
    !log?.actor_label &&
    (log?.user == null || log?.user === undefined) &&
    !log?.user_username;

  function passesFilter(log) {
    const mode = filterEl ? filterEl.value : 'all';
    if (mode === 'admin') return isAdminLog(log);
    if (mode === 'users') return isUserLog(log);
    if (mode === 'none')  return isNoneLog(log);
    return true;
  }
  function passesSearch(log) {
    const q = (searchEl?.value || '').trim().toLowerCase();
    return !q || actorName(log).toLowerCase().includes(q);
  }

  function getOpenSet() {
    const s = new Set();
    tbody.querySelectorAll('details[open][data-log-id]').forEach(d => {
      const id = d.getAttribute('data-log-id'); if (id) s.add(id);
    });
    return s;
  }
  function restoreOpen(s) {
    tbody.querySelectorAll('details[data-log-id]').forEach(d => {
      const id = d.getAttribute('data-log-id'); if (id && s.has(id)) d.setAttribute('open','');
    });
  }

  function render() {
    if (section.style.display === 'none') return;
    const open = getOpenSet();
    const list = rawData.filter(passesFilter).filter(passesSearch);
    tbody.innerHTML = list.length ? list.map(rowHtml).join('') :
      `<tr><td colspan="7" class="text-center text-muted">Нет записей</td></tr>`;
    restoreOpen(open);
  }

  async function fetchLogs() {
    try {
      const res = await apiFetch(`/admin/audit_logs/?limit=20&ordering=-action_time`);
      if (!res.ok) return;
      const data = await res.json();
      const hash = JSON.stringify(data.map(x => [x.id, x.action_time, x.action, x.actor_label, x.user]));
      if (hash === lastHash) { refreshTimes(); return; }
      lastHash = hash;
      rawData = data;
      render();
    } catch(_) {}
  }

  function refreshTimes() {
    tbody.querySelectorAll('tr').forEach(tr => {
      const exact = tr.children[1], when = tr.children[0];
      if (!exact || !when) return;
      const txt = exact.textContent.trim();
      const [date,time] = txt.split(' ');
      if (!date || !time) return;
      const [d,m,y] = date.split('.').map(Number);
      const [hh,mm,ss] = time.split(':').map(Number);
      const iso = new Date(y, m-1, d, hh, mm, ss).toISOString();
      when.textContent = ago(iso);
    });
  }

  function applyHidden(hidden) {
    if (hidden) {
      section.style.display = 'none';
      btn.textContent = 'Показать логи';
      btn.classList.add('collapsed');
      localStorage.setItem(LS_KEY, '1');
    } else {
      section.style.display = '';
      btn.textContent = 'Скрыть логи';
      btn.classList.remove('collapsed');
      localStorage.setItem(LS_KEY, '0');
      fetchLogs();
    }
  }

  document.addEventListener('visibilitychange', () => { if (!document.hidden) fetchLogs(); });
  filterEl?.addEventListener('change', render);
  searchEl?.addEventListener('input', () => { clearTimeout(render._t); render._t = setTimeout(render, 150); });

  fetchLogs();
  setInterval(() => { if (!document.hidden && !section.hidden && section.style.display !== 'none') fetchLogs(); }, intervalMs);
})();
</script>


<script>
(function () {
  const section = document.getElementById('auditSection');
  const btn     = document.getElementById('auditToggleBtn');
  if (!section || !btn) return;

  const LS_KEY = 'audit_logs_hidden';

  function setHidden(hidden) {
    section.hidden = !!hidden;
    btn.setAttribute('aria-expanded', hidden ? 'false' : 'true');
    btn.innerHTML = (hidden ? 'Показать' : 'Скрыть') +
      ' логи <span class="text-light-emphasis small">(Alt+V)</span>';
    localStorage.setItem(LS_KEY, hidden ? '1' : '0');
  }

  setHidden(localStorage.getItem(LS_KEY) === '1');

  btn.addEventListener('click', () => setHidden(!section.hidden));

  document.addEventListener('keydown', (e) => {
    const tag = (document.activeElement?.tagName || '').toLowerCase();
    if (tag === 'input' || tag === 'textarea' || tag === 'select' || document.activeElement?.isContentEditable) return;

    if (e.altKey && !e.ctrlKey && e.code === 'KeyV') {
      e.preventDefault();
      document.getElementById('auditToggleBtn')?.click();
    }
  });
})();
</script>

{% endblock %}