
# Тест‑план проекта (пункт 4: Тестирование)

**Система:** API Car Dealer (DRF + PostgreSQL)  
**Версия:** 1.0  
**Дата:** 2025-09-24

## 1. Цели тестирования
Подтвердить соответствие функциональных, нефункциональных и регламентных требований из ТЗ, включая:
- Функциональность: CRUD, поиск/сортировки/фильтры, роли, процедуры/триггеры, транзакции.
- Интеграции: взаимодействие клиента и API, импорт/экспорт.
- Производительность/надежность: массовые операции, пакетные транзакции.
- Безопасность: защита от SQL-инъекций, корректное разграничение прав, шифрование/маскирование.
- Отказоустойчивость: восстановление из резервной копии, целостность.
- Автоматизация: регресс через pytest, smoke в CI.

## 2. Область и объекты тестирования
- REST API `/api/v1/...` (Cars, Makes, Models, Users/Roles, Orders/Transactions, Reviews, Audit, Backups, UserSettings).
- БД: представления, хранимые процедуры, триггеры, ограничения.
- Веб‑клиент (основные сценарии входа/просмотра/операций).
- Скрипты бэкапа/восстановления.

## 3. Подход
- **Функциональные тесты**: API‑уровень (pytest + requests).
- **Интеграционные**: клиент ↔ API, импорт/экспорт (Postman/newman; pytest).
- **Нагрузочные**: Locust (см. `load/locustfile.py`) — быстрый профиль и расширенный.
- **Безопасность**: негативные кейсы для фильтров/поиска, проверки RBAC, базовая статическая проверка конфигов.
- **Отказоустойчивость**: сценарий «сбой → restore → verify» (см. `resilience/resilience_test.sh`).

## 4. Среда
- БД: PostgreSQL 14+.
- Тестовые данные: фикстуры через API и/или SQL‑скрипты (см. `tests/conftest.py`).
- Токены: переменные окружения `ADMIN_TOKEN`, `USER_TOKEN`, `ANALYST_TOKEN`.
- База URL: `API_BASE_URL` (по умолчанию `http://localhost:8000`).

## 5. Критерии входа/выхода
**Вход:** Развёрнутая тестовая среда, доступ к API/БД, валидные токены.  
**Выход:** 0 критических/блокирующих дефектов, 95% функциональных кейсов — PASS, успешный сценарий restore.

## 6. Риски и допущения
- Несоответствие эндпойнтов/имён сущностей — тесты помечены `xfail/skip`, быстро чинятся конфигом.
- Не все отчёты CSV реализованы — интеграционные тесты допускают 404 как «не реализовано».

## 7. Артефакты на выходе
- Тест‑кейсы (см. `docs/test_cases.xlsx` или `docs/test_cases.csv`).
- Журналы прогонов (`docs/run_logs/*.md`), отчёт о дефектах (`docs/defects.csv`), итоговый отчёт (`docs/final_report.md`).

## 8. Покрытие
- CRUD: Cars/Makes/Models/Users/Roles/Orders/Transactions/Reviews/UserSettings.
- Фильтры/сортировки: по цене/марке/модели/датам, пагинация.
- Роли: admin/user/analyst и доступы на запись/просмотр/отчёты/аудит/бэкапы.
- Процедуры/триггеры: резерв/продажа/массовое изменение цены; аудит до/после.
- Транзакции: атомарность операций (успех/откат при ошибках).
- Импорт/экспорт: CSV и SQL (бэкап), Postman сценарии.
- Нагрузка: листинг, поиск, создание/обновление заказов, пакетные транзакции.
- Безопасность: SQLi попытки, эскалация прав, маскирование/шифрование PII (если есть).
- Отказоустойчивость: восстановление и верификация.

## 9. План работ
1) Подготовка тестовых данных и токенов.  
2) Запуск `scripts/run_pytests.sh`.  
3) (Опц.) `scripts/run_postman.sh` для интеграции.  
4) Нагрузка `locust -f load/locustfile.py` (короткий 2–5 минут).  
5) Сбой и restore: `resilience/resilience_test.sh`.  
6) Сбор артефактов и формирование финального отчёта.
